<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Analysis</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', Roboto, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0;
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 50%, #1a202c 100%);
            color: #ffffff;
            min-height: 100vh;
        }
        
        /* Header Design */
        .app-header {
            background: linear-gradient(145deg, #2d3748, #1a202c);
            padding: 15px 30px;
            border-bottom: 1px solid #4a5568;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .app-title {
            font-size: 24px;
            font-weight: 700;
            color: #ffffff;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .app-title::before {
            content: "ğŸ“ˆ";
            font-size: 28px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }
        
        .app-status {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 14px;
            color: #a0aec0;
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #48bb78;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* Main Content */
        .main-content {
            padding: 25px 30px;
        }
        .input-section {
            background: linear-gradient(145deg, #2d3748, #1a202c);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            border: 1px solid #4a5568;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        .input-section label {
            color: #e2e8f0;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }
        .input-section input, .input-section select, .input-section button {
            margin: 8px;
            padding: 12px 16px;
            border-radius: 8px;
            border: 1px solid #4a5568;
            background: #1a202c;
            color: #e2e8f0;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        .input-section input:focus, .input-section select:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.3);
            background: #2d3748;
        }
        .input-section button {
            background: linear-gradient(145deg, #4299e1, #3182ce);
            color: #ffffff;
            font-weight: 600;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-color: #3b82f6;
        }
        .input-section button:hover {
            background: linear-gradient(145deg, #2563eb, #1d4ed8);
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.25);
        }
        .chart-container {
            margin: 25px 0;
            background: linear-gradient(145deg, #ffffff, #f8fafc);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #cbd5e1;
            box-shadow: 0 8px 32px rgba(30, 41, 59, 0.08);
        }
        .signal-box {
            padding: 18px;
            margin: 12px 0;
            border-radius: 10px;
            border: 1px solid;
            backdrop-filter: blur(10px);
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(255,255,255,0.8);
        }
        .buy-signal { 
            background: linear-gradient(145deg, rgba(34, 197, 94, 0.1), rgba(16, 185, 129, 0.1)); 
            color: #059669; 
            border-color: #10b981;
        }
        .sell-signal { 
            background: linear-gradient(145deg, rgba(239, 68, 68, 0.1), rgba(220, 38, 38, 0.1)); 
            color: #dc2626; 
            border-color: #ef4444;
        }
        .watch-signal { 
            background: linear-gradient(145deg, rgba(245, 158, 11, 0.1), rgba(217, 119, 6, 0.1)); 
            color: #d97706; 
            border-color: #f59e0b;
        }
        .loading { display: none; color: #3b82f6; font-weight: 600; }
        .memo-section {
            background: linear-gradient(145deg, #2d3748, #1a202c);
            padding: 25px;
            border-radius: 12px;
            margin-top: 25px;
            border: 1px solid #4a5568;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        .memo-section h3 {
            margin-top: 0;
            color: #e2e8f0;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        .memo-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .memo-table th {
            background: linear-gradient(145deg, #4a5568, #2d3748);
            border: 1px solid #4a5568;
            padding: 12px 10px;
            text-align: center;
            font-weight: bold;
            color: #e2e8f0;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        .memo-table td {
            border: 1px solid #4a5568;
            padding: 8px 10px;
            background: rgba(26, 32, 44, 0.8);
        }
        .memo-table input {
            width: 100%;
            border: none;
            background: transparent;
            padding: 8px;
            font-size: 14px;
            color: #e2e8f0;
        }
        .memo-table input:focus {
            background: rgba(248, 250, 252, 1);
            border: 1px solid #3b82f6;
            outline: none;
            border-radius: 4px;
        }
        .memo-table tr:nth-child(even) {
            background-color: rgba(241, 245, 249, 0.5);
        }
        .memo-table tr:hover {
            background-color: rgba(59, 130, 246, 0.05);
        }
        .memo-status {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            text-align: right;
        }
        .memo-status.saved {
            color: #4CAF50;
        }
        .memo-table-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .memo-table-container::-webkit-scrollbar {
            width: 8px;
        }
        .memo-table-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .memo-table-container::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        .memo-table-container::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* ãƒ•ã‚¡ãƒ³ãƒ€ãƒ¡ãƒ³ã‚¿ãƒ«åˆ†æç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .analysis-section {
            background: linear-gradient(145deg, #ffffff, #f8fafc);
            padding: 25px;
            border-radius: 12px;
            margin: 20px 0;
            border: 1px solid #cbd5e1;
            box-shadow: 0 8px 32px rgba(30, 41, 59, 0.08);
        }
        .analysis-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
        }
        .analysis-card {
            background: linear-gradient(145deg, #ffffff, #f8fafc);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #cbd5e1;
            box-shadow: 0 4px 16px rgba(30, 41, 59, 0.05);
        }
        .analysis-card h4 {
            margin: 0 0 15px 0;
            color: #475569;
            font-size: 18px;
            font-weight: 700;
        }
        .metric-row {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 5px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .metric-label {
            font-weight: bold;
            color: #64748b;
        }
        .metric-value {
            color: #1e293b;
            font-weight: 600;
        }
        .rating-positive { color: #059669; font-weight: bold; }
        .rating-negative { color: #dc2626; font-weight: bold; }
        .rating-neutral { color: #d97706; font-weight: bold; }
        .investment-advice {
            background: linear-gradient(145deg, #dbeafe, #bfdbfe);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border: 1px solid #93c5fd;
        }
        .advice-recommendation {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .advice-list {
            margin: 8px 0;
        }
        .advice-list ul {
            margin: 5px 0;
            padding-left: 20px;
        }
        .tabs {
            display: flex;
            border-bottom: 2px solid #cbd5e1;
            margin-bottom: 20px;
        }
        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border: 1px solid #cbd5e1;
            background: linear-gradient(145deg, #ffffff, #f8fafc);
            border-radius: 10px 10px 0 0;
            margin-right: 8px;
            color: #475569;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .tab:hover {
            background: linear-gradient(145deg, #f8fafc, #e2e8f0);
            transform: translateY(-2px);
            border-color: #3b82f6;
        }
        .tab.active {
            background: linear-gradient(145deg, #3b82f6, #2563eb);
            color: #ffffff;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.25);
            border-color: #3b82f6;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        /* ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .backtest-controls {
            background: linear-gradient(145deg, #ffffff, #f8fafc);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            border: 1px solid #cbd5e1;
            box-shadow: 0 8px 32px rgba(30, 41, 59, 0.08);
        }
        
        .control-row {
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .control-row label {
            min-width: 100px;
            font-weight: 600;
            color: #475569;
        }
        
        .control-row input, .control-row select {
            padding: 8px 12px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            background: #ffffff;
        }
        
        .backtest-button {
            background: linear-gradient(145deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s ease;
        }
        
        .backtest-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
        }
        
        .backtest-results {
            margin-top: 25px;
        }
        
        .performance-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 25px 0;
            padding: 20px 0;
        }
        
        .performance-card {
            background: linear-gradient(145deg, #ffffff, #f8fafc);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #cbd5e1;
            text-align: center;
            box-shadow: 0 4px 16px rgba(30, 41, 59, 0.08);
        }
        
        .performance-card h4 {
            margin: 0 0 10px 0;
            color: #475569;
            font-size: 14px;
        }
        
        .performance-card .value {
            font-size: 24px;
            font-weight: 700;
            margin: 5px 0;
        }
        
        .performance-card .value.positive {
            color: #10b981;
        }
        
        .performance-card .value.negative {
            color: #ef4444;
        }
        
        .performance-card .value.neutral {
            color: #3b82f6;
        }
        
        .results-charts {
            display: flex;
            flex-direction: column;
            gap: 25px;
            margin: 35px 0;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
        }
        
        .chart-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 50px;
            padding-bottom: 30px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .results-charts .chart-container {
            height: 400px;
            min-height: 350px;
            margin: 0;
            position: relative;
            z-index: 1;
        }
        
        .results-details {
            margin-top: 50px;
            padding-top: 30px;
            border-top: 2px solid #e2e8f0;
            clear: both;
            position: relative;
            z-index: 2;
            background: #ffffff;
        }
        
        .tabs-sub {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .tab-sub {
            background: linear-gradient(145deg, #f8fafc, #e2e8f0);
            border: none;
            padding: 12px 20px;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-weight: 600;
            color: #64748b;
            transition: all 0.3s ease;
        }
        
        .tab-sub.active {
            background: linear-gradient(145deg, #3b82f6, #2563eb);
            color: #ffffff;
            transform: translateY(-2px);
        }
        
        .sub-tab-content {
            display: none;
        }
        
        .sub-tab-content.active {
            display: block;
        }
        
        .trades-table {
            overflow-x: auto;
            margin-top: 20px;
            position: relative;
            z-index: 3;
            background: #ffffff;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 16px rgba(30, 41, 59, 0.08);
        }
        
        .trades-table table {
            width: 100%;
            border-collapse: collapse;
            background: #ffffff;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(30, 41, 59, 0.08);
        }
        
        .trades-table th, .trades-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .trades-table th {
            background: linear-gradient(145deg, #f1f5f9, #e2e8f0);
            font-weight: 600;
            color: #475569;
        }
        
        .trades-table .profit {
            color: #10b981;
            font-weight: 600;
        }
        
        .trades-table .loss {
            color: #ef4444;
            font-weight: 600;
        }
        
        /* Portfolio Management Styles */
        .portfolio-section {
            background: linear-gradient(145deg, #ffffff, #f8fafc);
            padding: 25px;
            border-radius: 12px;
            margin: 20px 0;
            border: 1px solid #cbd5e1;
            box-shadow: 0 8px 32px rgba(30, 41, 59, 0.08);
        }
        .portfolio-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
        }
        .portfolio-card {
            background: linear-gradient(145deg, #ffffff, #f8fafc);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #cbd5e1;
            box-shadow: 0 4px 16px rgba(30, 41, 59, 0.05);
        }
        .portfolio-summary {
            background: linear-gradient(145deg, #f0f9ff, #e0f2fe);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #0284c7;
            margin-bottom: 20px;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .summary-item {
            text-align: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
        }
        .summary-item .label {
            font-size: 12px;
            color: #64748b;
            margin-bottom: 5px;
        }
        .summary-item .value {
            font-size: 18px;
            font-weight: bold;
            color: #1e293b;
        }
        .summary-item .positive {
            color: #059669;
        }
        .summary-item .negative {
            color: #dc2626;
        }
        .portfolio-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .portfolio-table th {
            background: linear-gradient(145deg, #f1f5f9, #e2e8f0);
            border: 1px solid #cbd5e1;
            padding: 12px 8px;
            text-align: center;
            font-weight: bold;
            color: #475569;
            font-size: 12px;
        }
        .portfolio-table td {
            border: 1px solid #cbd5e1;
            padding: 8px;
            text-align: center;
            background: rgba(248, 250, 252, 0.8);
            font-size: 12px;
        }
        .portfolio-table .profit {
            color: #059669;
            font-weight: bold;
        }
        .portfolio-table .loss {
            color: #dc2626;
            font-weight: bold;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #475569;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            background: #ffffff;
            color: #1e293b;
            font-size: 14px;
            box-sizing: border-box;
        }
        .form-group textarea {
            height: 80px;
            resize: vertical;
        }
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .btn-primary {
            background: linear-gradient(145deg, #3b82f6, #2563eb);
            color: white;
        }
        .btn-primary:hover {
            background: linear-gradient(145deg, #2563eb, #1d4ed8);
            transform: translateY(-1px);
        }
        .btn-danger {
            background: linear-gradient(145deg, #ef4444, #dc2626);
            color: white;
        }
        .btn-danger:hover {
            background: linear-gradient(145deg, #dc2626, #b91c1c);
            transform: translateY(-1px);
        }
        .btn-secondary {
            background: linear-gradient(145deg, #6b7280, #4b5563);
            color: white;
        }
        .btn-secondary:hover {
            background: linear-gradient(145deg, #4b5563, #374151);
            transform: translateY(-1px);
        }
        .portfolio-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
        }
        .portfolio-tab {
            padding: 12px 20px;
            cursor: pointer;
            border: none;
            background: none;
            color: #64748b;
            font-weight: 600;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }
        .portfolio-tab:hover {
            color: #3b82f6;
            background: rgba(59, 130, 246, 0.05);
        }
        .portfolio-tab.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }
        .portfolio-tab-content {
            display: none;
        }
        .portfolio-tab-content.active {
            display: block;
        }
        .note-item {
            background: linear-gradient(145deg, #ffffff, #f8fafc);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #cbd5e1;
            margin-bottom: 10px;
        }
        .note-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .note-title {
            font-weight: bold;
            color: #1e293b;
        }
        .note-meta {
            font-size: 12px;
            color: #64748b;
        }
        .note-content {
            color: #475569;
            line-height: 1.5;
        }
        .history-item {
            background: linear-gradient(145deg, #ffffff, #f8fafc);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #cbd5e1;
            margin-bottom: 10px;
        }
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .history-type {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }
        .history-type.technical {
            background: #dbeafe;
            color: #1d4ed8;
        }
        .history-type.fundamental {
            background: #d1fae5;
            color: #047857;
        }
        .history-type.backtest {
            background: #fef3c7;
            color: #92400e;
        }
        
        .detailed-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .metric-group {
            background: linear-gradient(145deg, #ffffff, #f8fafc);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #cbd5e1;
            box-shadow: 0 4px 16px rgba(30, 41, 59, 0.08);
        }
        
        .metric-group h4 {
            margin: 0 0 15px 0;
            color: #1e293b;
            font-size: 16px;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }
        
        .metric-item {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 5px 0;
        }
        
        .metric-label {
            color: #64748b;
        }
        
        .metric-value {
            font-weight: 600;
            color: #1e293b;
        }
        
        .loading-spinner {
            border: 4px solid #e2e8f0;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* æ–°ã—ã„ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆUIç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .backtest-explanation {
            background: linear-gradient(145deg, #f0f9ff, #e0f2fe);
            border: 2px solid #0ea5e9;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(14, 165, 233, 0.1);
        }
        
        .explanation-content {
            margin-top: 15px;
        }
        
        .explanation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .explanation-card {
            background: linear-gradient(145deg, #ffffff, #f8fafc);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #cbd5e1;
            box-shadow: 0 4px 16px rgba(30, 41, 59, 0.08);
        }
        
        .explanation-card h4 {
            margin: 0 0 12px 0;
            color: #1e293b;
            font-size: 16px;
        }
        
        .explanation-card ul, .explanation-card ol {
            margin: 0;
            padding-left: 20px;
        }
        
        .explanation-card li {
            margin: 8px 0;
            color: #475569;
            line-height: 1.5;
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 25px;
            margin: 20px 0;
        }
        
        .setting-group {
            background: linear-gradient(145deg, #ffffff, #f8fafc);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #cbd5e1;
            box-shadow: 0 4px 16px rgba(30, 41, 59, 0.08);
        }
        
        .setting-group h4 {
            margin: 0 0 8px 0;
            color: #1e293b;
            font-size: 16px;
        }
        
        .setting-description {
            color: #64748b;
            font-size: 14px;
            margin: 0 0 15px 0;
            line-height: 1.4;
        }
        
        .preset-buttons {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .preset-btn {
            background: linear-gradient(145deg, #e2e8f0, #cbd5e1);
            border: 1px solid #94a3b8;
            color: #475569;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .preset-btn:hover {
            background: linear-gradient(145deg, #cbd5e1, #94a3b8);
            transform: translateY(-1px);
        }
        
        .strategy-description {
            background: linear-gradient(145deg, #fef3c7, #fde68a);
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 12px;
            margin-top: 10px;
            font-size: 14px;
            color: #92400e;
            line-height: 1.4;
        }
        
        .setting-note {
            display: block;
            color: #64748b;
            font-style: italic;
            margin-top: 8px;
            line-height: 1.3;
        }
        
        .execute-section {
            text-align: center;
            margin-top: 30px;
            padding: 25px;
            background: linear-gradient(145deg, #f8fafc, #e2e8f0);
            border-radius: 12px;
            border: 1px solid #cbd5e1;
        }
        
        .execute-note {
            margin: 10px 0 0 0;
            color: #64748b;
            font-size: 14px;
            font-style: italic;
        }
        
        .results-interpretation {
            margin-bottom: 20px;
        }
        
        .interpretation-toggle {
            margin-bottom: 15px;
        }
        
        .guide-toggle-btn {
            background: linear-gradient(145deg, #fbbf24, #f59e0b);
            color: #92400e;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }
        
        .guide-toggle-btn:hover {
            background: linear-gradient(145deg, #f59e0b, #d97706);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.3);
        }
        
        .results-guide {
            background: linear-gradient(145deg, #fefce8, #fef3c7);
            border: 2px solid #eab308;
            border-radius: 12px;
            padding: 20px;
            margin-top: 15px;
        }
        
        .guide-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
        }
        
        .guide-item {
            background: linear-gradient(145deg, #ffffff, #fefcf9);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #fbbf24;
        }
        
        .guide-item h5 {
            margin: 0 0 8px 0;
            color: #92400e;
            font-size: 14px;
        }
        
        .guide-item p {
            margin: 0;
            color: #78716c;
            font-size: 13px;
            line-height: 1.4;
        }
        
        .overall-rating {
            margin: 25px 0;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            font-weight: 600;
            font-size: 18px;
            clear: both;
        }
        
        .overall-rating.excellent {
            background: linear-gradient(145deg, #dcfce7, #bbf7d0);
            border: 2px solid #16a34a;
            color: #166534;
        }
        
        .overall-rating.good {
            background: linear-gradient(145deg, #fef3c7, #fde68a);
            border: 2px solid #eab308;
            color: #92400e;
        }
        
        .overall-rating.poor {
            background: linear-gradient(145deg, #fecaca, #fca5a5);
            border: 2px solid #dc2626;
            color: #991b1b;
        }
        
        @media (max-width: 768px) {
            .chart-section {
                grid-template-columns: 1fr;
                margin-bottom: 30px;
            }
            
            .results-charts .chart-container {
                height: 300px;
                min-height: 250px;
            }
            
            .results-details {
                margin-top: 30px;
                padding-top: 20px;
            }
            
            .performance-cards {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .control-row {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .control-row label {
                min-width: auto;
            }
            
            .explanation-grid {
                grid-template-columns: 1fr;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
            }
            
            .preset-buttons {
                justify-content: center;
            }
            
            .guide-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Application Header -->
    <div class="app-header">
        <div class="app-title">Stock Analysis</div>
        <div class="app-status">
            <span class="status-indicator"></span>
            <span>Live Market Data</span>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
    
    <div class="input-section">
        <label for="ticker">éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ï¼ˆ4æ¡ï¼‰:</label>
        <input type="text" id="ticker" placeholder="ä¾‹: 7203ï¼ˆãƒˆãƒ¨ã‚¿ï¼‰" maxlength="4" value="">
        
        <label for="period">æœŸé–“:</label>
        <select id="period">
            <option value="3mo">3ãƒ¶æœˆ</option>
            <option value="6mo" selected>6ãƒ¶æœˆ</option>
            <option value="1y">1å¹´</option>
        </select>
        
        <button onclick="analyzeStock()">åˆ†æé–‹å§‹</button>
        <span class="loading" id="loading">åˆ†æä¸­...</span>
    </div>
    
    <div class="memo-section">
        <h3>ğŸ“ æŠ•è³‡ãƒ¡ãƒ¢ä¸€è¦§</h3>
        <div class="memo-table-container">
            <table class="memo-table">
            <thead>
                <tr>
                    <th style="width: 15%;">éŠ˜æŸ„ç•ªå·</th>
                    <th style="width: 25%;">éŠ˜æŸ„å</th>
                    <th style="width: 60%;">ãƒ¡ãƒ¢</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><input type="text" placeholder="" maxlength="4"></td>
                    <td><input type="text" placeholder=""></td>
                    <td><input type="text" placeholder=""></td>
                </tr>
                <tr>
                    <td><input type="text" placeholder="" maxlength="4"></td>
                    <td><input type="text" placeholder=""></td>
                    <td><input type="text" placeholder=""></td>
                </tr>
                <tr>
                    <td><input type="text" placeholder="" maxlength="4"></td>
                    <td><input type="text" placeholder=""></td>
                    <td><input type="text" placeholder=""></td>
                </tr>
                <tr>
                    <td><input type="text" placeholder="" maxlength="4"></td>
                    <td><input type="text" placeholder=""></td>
                    <td><input type="text" placeholder=""></td>
                </tr>
                <tr>
                    <td><input type="text" placeholder="" maxlength="4"></td>
                    <td><input type="text" placeholder=""></td>
                    <td><input type="text" placeholder=""></td>
                </tr>
                <tr>
                    <td><input type="text" placeholder="" maxlength="4"></td>
                    <td><input type="text" placeholder=""></td>
                    <td><input type="text" placeholder=""></td>
                </tr>
                <tr>
                    <td><input type="text" placeholder="" maxlength="4"></td>
                    <td><input type="text" placeholder=""></td>
                    <td><input type="text" placeholder=""></td>
                </tr>
                <tr>
                    <td><input type="text" placeholder="" maxlength="4"></td>
                    <td><input type="text" placeholder=""></td>
                    <td><input type="text" placeholder=""></td>
                </tr>
                <tr>
                    <td><input type="text" placeholder="" maxlength="4"></td>
                    <td><input type="text" placeholder=""></td>
                    <td><input type="text" placeholder=""></td>
                </tr>
                <tr>
                    <td><input type="text" placeholder="" maxlength="4"></td>
                    <td><input type="text" placeholder=""></td>
                    <td><input type="text" placeholder=""></td>
                </tr>
                <tr>
                    <td><input type="text" placeholder="" maxlength="4"></td>
                    <td><input type="text" placeholder=""></td>
                    <td><input type="text" placeholder=""></td>
                </tr>
                <tr>
                    <td><input type="text" placeholder="" maxlength="4"></td>
                    <td><input type="text" placeholder=""></td>
                    <td><input type="text" placeholder=""></td>
                </tr>
                <tr>
                    <td><input type="text" placeholder="" maxlength="4"></td>
                    <td><input type="text" placeholder=""></td>
                    <td><input type="text" placeholder=""></td>
                </tr>
                <tr>
                    <td><input type="text" placeholder="" maxlength="4"></td>
                    <td><input type="text" placeholder=""></td>
                    <td><input type="text" placeholder=""></td>
                </tr>
                <tr>
                    <td><input type="text" placeholder="" maxlength="4"></td>
                    <td><input type="text" placeholder=""></td>
                    <td><input type="text" placeholder=""></td>
                </tr>
                <tr>
                    <td><input type="text" placeholder="" maxlength="4"></td>
                    <td><input type="text" placeholder=""></td>
                    <td><input type="text" placeholder=""></td>
                </tr>
                <tr>
                    <td><input type="text" placeholder="" maxlength="4"></td>
                    <td><input type="text" placeholder=""></td>
                    <td><input type="text" placeholder=""></td>
                </tr>
                <tr>
                    <td><input type="text" placeholder="" maxlength="4"></td>
                    <td><input type="text" placeholder=""></td>
                    <td><input type="text" placeholder=""></td>
                </tr>
                <tr>
                    <td><input type="text" placeholder="" maxlength="4"></td>
                    <td><input type="text" placeholder=""></td>
                    <td><input type="text" placeholder=""></td>
                </tr>
            </tbody>
        </table>
        </div>
        <div class="memo-status" id="memo-status">ãƒ¡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>
    
    <div id="results" style="display: none;">
        <div class="tabs">
            <button class="tab active" onclick="showTab('technical-tab')">åŸºæœ¬ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«</button>
            <button class="tab" onclick="showTab('advanced-tab')">é«˜åº¦ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«</button>
            <button class="tab" onclick="showTab('fundamental-tab')">ãƒ•ã‚¡ãƒ³ãƒ€ãƒ¡ãƒ³ã‚¿ãƒ«</button>
            <button class="tab" onclick="showTab('backtest-tab')">ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆ</button>
            <button class="tab" onclick="showTab('portfolio-tab')">ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ª</button>
        </div>
        
        <div id="technical-tab" class="tab-content active">
            <div id="chart" class="chart-container"></div>
            <div id="signals"></div>
            <div id="golden-crosses"></div>
        </div>
        
        <div id="advanced-tab" class="tab-content">
            <!-- æŒ‡æ¨™è§£èª¬ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="analysis-section">
                <h3 style="color: #475569; margin-bottom: 20px;">ğŸ“š é«˜åº¦ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«æŒ‡æ¨™ã®è¦‹æ–¹ãƒ»ä½¿ã„æ–¹</h3>
                <div class="analysis-grid">
                    <div class="analysis-card">
                        <h4>ğŸ¯ ãƒœãƒªãƒ³ã‚¸ãƒ£ãƒ¼ãƒãƒ³ãƒ‰</h4>
                        <p><strong>æ¦‚è¦:</strong> ç§»å‹•å¹³å‡ç·šã‚’ä¸­å¿ƒã¨ã—ãŸä¾¡æ ¼ã®å¤‰å‹•å¹…ã‚’ç¤ºã™ãƒãƒ³ãƒ‰</p>
                        <p><strong>æ§‹æˆ:</strong></p>
                        <ul style="margin: 8px 0; padding-left: 20px; color: #64748b;">
                            <li>ä¸­å¤®ç·šï¼š20æ—¥ç§»å‹•å¹³å‡ç·š</li>
                            <li>ä¸Šé™ãƒ»ä¸‹é™ï¼šæ¨™æº–åå·®Â±2Ïƒ</li>
                        </ul>
                        <p><strong>æŠ•è³‡åˆ¤æ–­:</strong></p>
                        <ul style="margin: 8px 0; padding-left: 20px; color: #64748b;">
                            <li>ğŸ”´ <span style="color: #dc2626;">ä¸Šé™ã‚¿ãƒƒãƒ</span> â†’ å£²ã‚Šã‚·ã‚°ãƒŠãƒ«ï¼ˆè²·ã‚ã‚Œã™ãï¼‰</li>
                            <li>ğŸŸ¢ <span style="color: #059669;">ä¸‹é™ã‚¿ãƒƒãƒ</span> â†’ è²·ã„ã‚·ã‚°ãƒŠãƒ«ï¼ˆå£²ã‚‰ã‚Œã™ãï¼‰</li>
                            <li>ğŸŸ¡ <span style="color: #d97706;">ãƒãƒ³ãƒ‰å¹…ç¸®å°</span> â†’ å¤§ããªå€¤å‹•ãå‰ã®å‰å…†</li>
                        </ul>
                    </div>
                    
                    <div class="analysis-card">
                        <h4>ğŸ“Š MACD</h4>
                        <p><strong>æ¦‚è¦:</strong> ç§»å‹•å¹³å‡åæŸæ‹¡æ•£æŒ‡æ¨™ã€‚ãƒˆãƒ¬ãƒ³ãƒ‰ã®å¼·ã•ã¨è»¢æ›ç‚¹ã‚’åˆ¤å®š</p>
                        <p><strong>æ§‹æˆ:</strong></p>
                        <ul style="margin: 8px 0; padding-left: 20px; color: #64748b;">
                            <li>MACDç·šï¼š12æ—¥EMA - 26æ—¥EMA</li>
                            <li>ã‚·ã‚°ãƒŠãƒ«ç·šï¼šMACDç·šã®9æ—¥EMA</li>
                            <li>ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ï¼šMACDç·š - ã‚·ã‚°ãƒŠãƒ«ç·š</li>
                        </ul>
                        <p><strong>æŠ•è³‡åˆ¤æ–­:</strong></p>
                        <ul style="margin: 8px 0; padding-left: 20px; color: #64748b;">
                            <li>ğŸŸ¢ <span style="color: #059669;">ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ã‚¯ãƒ­ã‚¹</span> â†’ è²·ã„ã‚·ã‚°ãƒŠãƒ«</li>
                            <li>ğŸ”´ <span style="color: #dc2626;">ãƒ‡ãƒƒãƒ‰ã‚¯ãƒ­ã‚¹</span> â†’ å£²ã‚Šã‚·ã‚°ãƒŠãƒ«</li>
                            <li>ğŸ“ˆ <span style="color: #3b82f6;">ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ æ‹¡å¤§</span> â†’ ãƒˆãƒ¬ãƒ³ãƒ‰å¼·åŒ–</li>
                        </ul>
                    </div>
                    
                    <div class="analysis-card">
                        <h4>âš¡ ã‚¹ãƒˆã‚­ãƒ£ã‚¹ãƒ†ã‚£ã‚¯ã‚¹</h4>
                        <p><strong>æ¦‚è¦:</strong> ä¸€å®šæœŸé–“ã®ä¾¡æ ¼ãƒ¬ãƒ³ã‚¸å†…ã§ã®ç¾åœ¨ä¾¡æ ¼ã®ä½ç½®ã‚’%ã§è¡¨ç¤º</p>
                        <p><strong>æ§‹æˆ:</strong></p>
                        <ul style="margin: 8px 0; padding-left: 20px; color: #64748b;">
                            <li>%Kç·šï¼šé«˜å€¤ãƒ»å®‰å€¤ãƒ¬ãƒ³ã‚¸ã§ã®ç¾åœ¨ä¾¡æ ¼ä½ç½®</li>
                            <li>%Dç·šï¼š%Kç·šã®3æ—¥å¹³æ»‘ç§»å‹•å¹³å‡</li>
                        </ul>
                        <p><strong>æŠ•è³‡åˆ¤æ–­:</strong></p>
                        <ul style="margin: 8px 0; padding-left: 20px; color: #64748b;">
                            <li>ğŸ”´ <span style="color: #dc2626;">80%ä»¥ä¸Š</span> â†’ è²·ã‚ã‚Œã™ãï¼ˆå£²ã‚Šæ¤œè¨ï¼‰</li>
                            <li>ğŸŸ¢ <span style="color: #059669;">20%ä»¥ä¸‹</span> â†’ å£²ã‚‰ã‚Œã™ãï¼ˆè²·ã„æ¤œè¨ï¼‰</li>
                            <li>âœ¨ <span style="color: #3b82f6;">%K > %D</span> â†’ ä¸Šæ˜‡ã®å‹¢ã„</li>
                        </ul>
                    </div>
                    
                    <div class="analysis-card">
                        <h4>ğŸ“ˆ å‡ºæ¥é«˜åˆ†æ</h4>
                        <p><strong>æ¦‚è¦:</strong> ä¾¡æ ¼å¤‰å‹•ã¨å‡ºæ¥é«˜ã®é–¢ä¿‚ã‚’åˆ†æã€‚ãƒˆãƒ¬ãƒ³ãƒ‰ã®ç¢ºå®Ÿæ€§ã‚’åˆ¤å®š</p>
                        <p><strong>æ§‹æˆ:</strong></p>
                        <ul style="margin: 8px 0; padding-left: 20px; color: #64748b;">
                            <li>å‡ºæ¥é«˜ï¼šå®Ÿéš›ã®å–å¼•é‡</li>
                            <li>å‡ºæ¥é«˜ç§»å‹•å¹³å‡ï¼š20æ—¥é–“ã®å¹³å‡å‡ºæ¥é«˜</li>
                        </ul>
                        <p><strong>æŠ•è³‡åˆ¤æ–­:</strong></p>
                        <ul style="margin: 8px 0; padding-left: 20px; color: #64748b;">
                            <li>ğŸ”¥ <span style="color: #dc2626;">2å€ä»¥ä¸Š</span> â†’ ç•°å¸¸å‡ºæ¥é«˜ï¼ˆé‡è¦ãªå‹•ãï¼‰</li>
                            <li>ğŸ“Š <span style="color: #d97706;">1.5å€ä»¥ä¸Š</span> â†’ é«˜å‡ºæ¥é«˜ï¼ˆæ³¨ç›®ï¼‰</li>
                            <li>ğŸ’¡ <span style="color: #64748b;">ä¸Šæ˜‡+é«˜å‡ºæ¥é«˜</span> â†’ ä¸Šæ˜‡ãƒˆãƒ¬ãƒ³ãƒ‰ä¿¡é ¼æ€§é«˜</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- ãƒãƒ£ãƒ¼ãƒˆè¡¨ç¤º -->
            <div class="analysis-grid">
                <div id="bollinger-chart" class="chart-container"></div>
                <div id="macd-chart" class="chart-container"></div>
                <div id="stoch-chart" class="chart-container"></div>
                <div id="volume-chart" class="chart-container"></div>
            </div>
            <div id="advanced-signals"></div>
        </div>
        
        <div id="fundamental-tab" class="tab-content">
            <div id="fundamental-analysis" class="analysis-section"></div>
        </div>
        
        <div id="backtest-tab" class="tab-content">
            <!-- ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆèª¬æ˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="backtest-explanation">
                <h3>ğŸ”„ ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆã¨ã¯ï¼Ÿ</h3>
                <div class="explanation-content">
                    <p><strong>ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆ</strong>ã¯ã€éå»ã®æ ªä¾¡ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ã£ã¦æŠ•è³‡æˆ¦ç•¥ã®æœ‰åŠ¹æ€§ã‚’æ¤œè¨¼ã™ã‚‹ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã§ã™ã€‚</p>
                    
                    <div class="explanation-grid">
                        <div class="explanation-card">
                            <h4>ğŸ“Š ä½•ãŒã§ãã‚‹ï¼Ÿ</h4>
                            <ul>
                                <li>éå»ã®ç›¸å ´ã§æˆ¦ç•¥ãŒåˆ©ç›Šã‚’å‡ºã›ãŸã‹ç¢ºèª</li>
                                <li>ãƒªã‚¹ã‚¯ã¨ãƒªã‚¿ãƒ¼ãƒ³ã®é–¢ä¿‚ã‚’æ•°å€¤ã§æŠŠæ¡</li>
                                <li>è¤‡æ•°ã®æŠ•è³‡æˆ¦ç•¥ã‚’æ¯”è¼ƒæ¤œè¨</li>
                                <li>å®Ÿéš›ã®æŠ•è³‡å‰ã«ãƒªã‚¹ã‚¯ã‚’è©•ä¾¡</li>
                            </ul>
                        </div>
                        
                        <div class="explanation-card">
                            <h4>âš ï¸ æ³¨æ„ç‚¹</h4>
                            <ul>
                                <li>éå»ã®çµæœã¯å°†æ¥ã‚’ä¿è¨¼ã—ã¾ã›ã‚“</li>
                                <li>æ‰‹æ•°æ–™ãƒ»ç¨é‡‘ã¯è€ƒæ…®ã•ã‚Œã¦ã„ã¾ã›ã‚“</li>
                                <li>æµå‹•æ€§ãƒªã‚¹ã‚¯ã¯å«ã¾ã‚Œã¦ã„ã¾ã›ã‚“</li>
                                <li>å‚è€ƒæƒ…å ±ã¨ã—ã¦æ´»ç”¨ã—ã¦ãã ã•ã„</li>
                            </ul>
                        </div>
                        
                        <div class="explanation-card">
                            <h4>ğŸ“ˆ ä½¿ã„æ–¹ã®æµã‚Œ</h4>
                            <ol>
                                <li>æ¤œè¨¼ã—ãŸã„æœŸé–“ã‚’è¨­å®š</li>
                                <li>æŠ•è³‡æˆ¦ç•¥ã‚’é¸æŠ</li>
                                <li>åˆæœŸè³‡é‡‘ã‚’å…¥åŠ›</li>
                                <li>å®Ÿè¡Œãƒœã‚¿ãƒ³ã§ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹</li>
                                <li>çµæœã‚’åˆ†æã—ã¦æˆ¦ç•¥ã‚’è©•ä¾¡</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆè¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="backtest-controls">
                <h3>âš™ï¸ ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆè¨­å®š</h3>
                
                <div class="settings-grid">
                    <!-- æœŸé–“è¨­å®š -->
                    <div class="setting-group">
                        <h4>ğŸ“… æ¤œè¨¼æœŸé–“</h4>
                        <p class="setting-description">éå»ã®ã©ã®æœŸé–“ã§æˆ¦ç•¥ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ã‹ã‚’è¨­å®šã—ã¾ã™</p>
                        <div class="control-row">
                            <label>é–‹å§‹æ—¥:</label>
                            <input type="date" id="backtest-start-date" value="">
                        </div>
                        <div class="control-row">
                            <label>çµ‚äº†æ—¥:</label>
                            <input type="date" id="backtest-end-date" value="">
                        </div>
                        <div class="preset-buttons">
                            <button type="button" onclick="setPresetPeriod(90)" class="preset-btn">éå»3ãƒ¶æœˆ</button>
                            <button type="button" onclick="setPresetPeriod(180)" class="preset-btn">éå»6ãƒ¶æœˆ</button>
                            <button type="button" onclick="setPresetPeriod(365)" class="preset-btn">éå»1å¹´</button>
                        </div>
                    </div>
                    
                    <!-- æˆ¦ç•¥è¨­å®š -->
                    <div class="setting-group">
                        <h4>ğŸ¯ æŠ•è³‡æˆ¦ç•¥</h4>
                        <p class="setting-description">ã©ã®å£²è²·ãƒ«ãƒ¼ãƒ«ã§ãƒ†ã‚¹ãƒˆã™ã‚‹ã‹ã‚’é¸æŠã—ã¾ã™</p>
                        <div class="control-row">
                            <select id="strategy-select" onchange="showStrategyDescription()">
                                <option value="combo">è¤‡åˆæˆ¦ç•¥ï¼ˆæ¨å¥¨ï¼‰</option>
                                <option value="rsi">RSIæˆ¦ç•¥</option>
                                <option value="golden_cross">ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ã‚¯ãƒ­ã‚¹æˆ¦ç•¥</option>
                                <option value="macd">MACDæˆ¦ç•¥</option>
                                <option value="bollinger">ãƒœãƒªãƒ³ã‚¸ãƒ£ãƒ¼ãƒãƒ³ãƒ‰æˆ¦ç•¥</option>
                            </select>
                        </div>
                        <div id="strategy-description" class="strategy-description">
                            <strong>è¤‡åˆæˆ¦ç•¥:</strong> RSIã€ç§»å‹•å¹³å‡ç·šã€MACDã€ãƒœãƒªãƒ³ã‚¸ãƒ£ãƒ¼ãƒãƒ³ãƒ‰ã‚’çµ„ã¿åˆã‚ã›ãŸç·åˆçš„ãªåˆ¤å®šã‚’è¡Œã„ã¾ã™ã€‚è¤‡æ•°ã®æŒ‡æ¨™ã‚’ä½¿ã†ã“ã¨ã§ã‚ˆã‚Šç²¾åº¦ã®é«˜ã„å£²è²·ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’ç‹™ã„ã¾ã™ã€‚ï¼ˆåˆå¿ƒè€…ã«ãŠã™ã™ã‚ï¼‰
                        </div>
                    </div>
                    
                    <!-- è³‡é‡‘è¨­å®š -->
                    <div class="setting-group">
                        <h4>ğŸ’° åˆæœŸè³‡é‡‘</h4>
                        <p class="setting-description">æŠ•è³‡ã‚’ã‚¹ã‚¿ãƒ¼ãƒˆã™ã‚‹æ™‚ã®è³‡é‡‘é¡ã‚’è¨­å®šã—ã¾ã™</p>
                        <div class="control-row">
                            <input type="number" id="initial-capital" value="1000000" step="100000" min="100000">
                            <span>å††</span>
                        </div>
                        <div class="preset-buttons">
                            <button type="button" onclick="setCapital(500000)" class="preset-btn">50ä¸‡å††</button>
                            <button type="button" onclick="setCapital(1000000)" class="preset-btn">100ä¸‡å††</button>
                            <button type="button" onclick="setCapital(3000000)" class="preset-btn">300ä¸‡å††</button>
                        </div>
                        <small class="setting-note">ğŸ’¡ å®Ÿéš›ã®æŠ•è³‡é¡ã«è¿‘ã„é‡‘é¡ã‚’è¨­å®šã™ã‚‹ã¨ã€ã‚ˆã‚Šå®Ÿè·µçš„ãªçµæœãŒå¾—ã‚‰ã‚Œã¾ã™</small>
                    </div>
                </div>
                
                <div class="execute-section">
                    <button onclick="runBacktest()" class="backtest-button">
                        ğŸš€ ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
                    </button>
                    <p class="execute-note">â€» å®Ÿè¡Œã«ã¯æ•°ç§’ã€œæ•°åç§’ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™</p>
                </div>
            </div>
            
            <div id="backtest-results" class="backtest-results" style="display: none;">
                <div class="results-summary">
                    <h3>ğŸ“Š ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆçµæœ</h3>
                    <div class="results-interpretation">
                        <div class="interpretation-toggle">
                            <button type="button" onclick="toggleResultsGuide()" class="guide-toggle-btn">
                                ğŸ’¡ çµæœã®è¦‹æ–¹ã‚¬ã‚¤ãƒ‰ <span id="guide-toggle-icon">â–¼</span>
                            </button>
                        </div>
                        <div id="results-guide" class="results-guide" style="display: none;">
                            <div class="guide-grid">
                                <div class="guide-item">
                                    <h5>ğŸ“ˆ ç·ãƒªã‚¿ãƒ¼ãƒ³</h5>
                                    <p>æŠ•è³‡æœŸé–“å…¨ä½“ã§ã®åˆ©ç›Šç‡ã€‚ãƒ—ãƒ©ã‚¹ãªã‚‰åˆ©ç›Šã€ãƒã‚¤ãƒŠã‚¹ãªã‚‰æå¤±ã‚’è¡¨ã—ã¾ã™ã€‚å¹´åˆ©æ›ç®—ã—ã¦ä»–ã®æŠ•è³‡å•†å“ã¨æ¯”è¼ƒã—ã¾ã—ã‚‡ã†ã€‚</p>
                                </div>
                                <div class="guide-item">
                                    <h5>ğŸ¯ å‹ç‡</h5>
                                    <p>å…¨å–å¼•ã®ã†ã¡åˆ©ç›Šã‚’å‡ºã—ãŸå–å¼•ã®å‰²åˆã€‚é«˜ã„ã»ã©å®‰å®šã—ã¦ã„ã¾ã™ãŒã€50%ä»¥ä¸Šã‚ã‚Œã°è‰¯å¥½ã§ã™ã€‚</p>
                                </div>
                                <div class="guide-item">
                                    <h5>ğŸ“‰ æœ€å¤§ãƒ‰ãƒ­ãƒ¼ãƒ€ã‚¦ãƒ³</h5>
                                    <p>æœ€å¤§ã®æå¤±å¹…ã€‚æŠ•è³‡ã§è¦šæ‚Ÿã™ã¹ãæœ€å¤§ã®ä¸‹è½ã‚’ç¤ºã—ã¾ã™ã€‚10%ä»¥ä¸‹ãªã‚‰è‰¯å¥½ã€20%è¶…ã¯è¦æ³¨æ„ã§ã™ã€‚</p>
                                </div>
                                <div class="guide-item">
                                    <h5>âš–ï¸ ã‚·ãƒ£ãƒ¼ãƒ—ãƒ¬ã‚·ã‚ª</h5>
                                    <p>ãƒªã‚¹ã‚¯ã«å¯¾ã™ã‚‹ãƒªã‚¿ãƒ¼ãƒ³ã®åŠ¹ç‡æ€§ã€‚1.0ä»¥ä¸Šã§è‰¯å¥½ã€2.0ä»¥ä¸Šã§å„ªç§€ãªæˆ¦ç•¥ã¨è¨€ãˆã¾ã™ã€‚</p>
                                </div>
                                <div class="guide-item">
                                    <h5>ğŸª ãƒã‚¤&ãƒ›ãƒ¼ãƒ«ãƒ‰æ¯”è¼ƒ</h5>
                                    <p>å˜ç´”ã«è²·ã£ã¦æŒã¡ç¶šã‘ãŸå ´åˆã¨ã®æ¯”è¼ƒã€‚ãƒ—ãƒ©ã‚¹ãªã‚‰æˆ¦ç•¥ã«ä¾¡å€¤ãŒã‚ã‚‹ã“ã¨ã‚’ç¤ºã—ã¾ã™ã€‚</p>
                                </div>
                                <div class="guide-item">
                                    <h5>ğŸ“‹ ç·åˆåˆ¤å®š</h5>
                                    <p><strong>å„ªç§€:</strong> å…¨æŒ‡æ¨™ãŒè‰¯å¥½ã€€<strong>è‰¯å¥½:</strong> å¤šãã®æŒ‡æ¨™ãŒè‰¯å¥½ã€€<strong>è¦æ”¹å–„:</strong> ãƒªã‚¹ã‚¯ãŒé«˜ã„ã‹åç›Šæ€§ãŒä½ã„</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="performance-summary" class="performance-cards"></div>
                    <div id="overall-rating" class="overall-rating"></div>
                </div>
                
                <div class="results-charts">
                    <div class="chart-section">
                        <div id="backtest-chart" class="chart-container"></div>
                        <div id="performance-chart" class="chart-container"></div>
                    </div>
                </div>
                
                <div class="results-details">
                    <div class="tabs-sub">
                        <button class="tab-sub active" onclick="showSubTab('trade-list')">å–å¼•å±¥æ­´</button>
                        <button class="tab-sub" onclick="showSubTab('performance-metrics')">è©³ç´°æŒ‡æ¨™</button>
                        <button class="tab-sub" onclick="showSubTab('strategy-params')">æˆ¦ç•¥ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿</button>
                    </div>
                    
                    <div id="trade-list" class="sub-tab-content active">
                        <div id="trades-table" class="trades-table"></div>
                    </div>
                    
                    <div id="performance-metrics" class="sub-tab-content">
                        <div id="detailed-metrics" class="detailed-metrics"></div>
                    </div>
                    
                    <div id="strategy-params" class="sub-tab-content">
                        <div id="strategy-parameters" class="strategy-parameters"></div>
                    </div>
                </div>
            </div>
            
            <div id="backtest-loading" class="loading" style="display: none;">
                <div class="loading-spinner"></div>
                <p>ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­...</p>
            </div>
        </div>
        
        <div id="portfolio-tab" class="tab-content">
            <!-- Portfolio Management Section -->
            <div class="portfolio-section">
                <h3 style="color: #475569; margin-bottom: 20px;">ğŸ’¼ ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªç®¡ç†</h3>
                
                <!-- Portfolio Summary -->
                <div id="portfolio-summary" class="portfolio-summary">
                    <h4 style="margin: 0 0 15px 0; color: #0f172a;">ğŸ“ˆ ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã‚µãƒãƒªãƒ¼</h4>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="label">ä¿æœ‰éŠ˜æŸ„æ•°</div>
                            <div class="value" id="total-stocks">0</div>
                        </div>
                        <div class="summary-item">
                            <div class="label">ç·æŠ•è³‡é‡‘é¡</div>
                            <div class="value" id="total-investment">ï¿¥0</div>
                        </div>
                        <div class="summary-item">
                            <div class="label">ç¾åœ¨ä¾¡å€¤</div>
                            <div class="value" id="current-value">ï¿¥0</div>
                        </div>
                        <div class="summary-item">
                            <div class="label">æŸç›Š</div>
                            <div class="value" id="total-profit-loss">ï¿¥0</div>
                        </div>
                        <div class="summary-item">
                            <div class="label">æŸç›Šç‡</div>
                            <div class="value" id="total-profit-loss-pct">0.00%</div>
                        </div>
                    </div>
                </div>
                
                <!-- Portfolio Tabs -->
                <div class="portfolio-tabs">
                    <button class="portfolio-tab active" onclick="showPortfolioTab('portfolio-holdings')">Portfolio</button>
                    <button class="portfolio-tab" onclick="showPortfolioTab('watchlist')">Watchlist</button>
                    <button class="portfolio-tab" onclick="showPortfolioTab('notes')">ãƒ¡ãƒ¢</button>
                    <button class="portfolio-tab" onclick="showPortfolioTab('history')">History</button>
                </div>
                
                <!-- Portfolio Holdings Tab -->
                <div id="portfolio-holdings" class="portfolio-tab-content active">
                    <div class="portfolio-grid">
                        <div class="portfolio-card">
                            <h4>ğŸ“Š ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªä¸€è¦§</h4>
                            <div id="portfolio-table-container">
                                <table class="portfolio-table">
                                    <thead>
                                        <tr>
                                            <th>éŠ˜æŸ„</th>
                                            <th>ä¼æ¥­å</th>
                                            <th>ä¿æœ‰æ•°</th>
                                            <th>å¹³å‡å–å¾—ä¾¡æ ¼</th>
                                            <th>ç¾åœ¨ä¾¡æ ¼</th>
                                            <th>æŸç›Š</th>
                                            <th>æŸç›Šç‡</th>
                                            <th>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</th>
                                        </tr>
                                    </thead>
                                    <tbody id="portfolio-tbody">
                                        <tr>
                                            <td colspan="8" style="text-align: center; color: #64748b; padding: 20px;">
                                                ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="portfolio-card">
                            <h4>â• éŠ˜æŸ„è¿½åŠ </h4>
                            <form id="add-to-portfolio-form">
                                <div class="form-group">
                                    <label for="add-ticker">éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ (4æ¡)</label>
                                    <input type="text" id="add-ticker" maxlength="4" placeholder="7203" required>
                                </div>
                                <div class="form-group">
                                    <label for="add-shares">ä¿æœ‰æ•°</label>
                                    <input type="number" id="add-shares" min="1" placeholder="100" required>
                                </div>
                                <div class="form-group">
                                    <label for="add-price">å¹³å‡å–å¾—ä¾¡æ ¼</label>
                                    <input type="number" id="add-price" min="0" step="0.01" placeholder="2800" required>
                                </div>
                                <div class="form-group">
                                    <label for="add-notes">ãƒ¡ãƒ¢ (ä»»æ„)</label>
                                    <textarea id="add-notes" placeholder="è³¼å…¥ç†ç”±ã‚„ãƒ¡ãƒ¢ã‚’è¨˜å…¥..."></textarea>
                                </div>
                                <div class="btn-group">
                                    <button type="submit" class="btn btn-primary">è¿½åŠ </button>
                                    <button type="button" class="btn btn-secondary" onclick="clearAddForm()">ã‚¯ãƒªã‚¢</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Watchlist Tab -->
                <div id="watchlist" class="portfolio-tab-content">
                    <div class="portfolio-grid">
                        <div class="portfolio-card">
                            <h4>ğŸ‘€ ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆ</h4>
                            <div id="watchlist-table-container">
                                <table class="portfolio-table">
                                    <thead>
                                        <tr>
                                            <th>éŠ˜æŸ„</th>
                                            <th>ä¼æ¥­å</th>
                                            <th>ç›®æ¨™ä¾¡æ ¼</th>
                                            <th>ã‚¢ãƒ©ãƒ¼ãƒˆ</th>
                                            <th>è¿½åŠ æ—¥</th>
                                            <th>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</th>
                                        </tr>
                                    </thead>
                                    <tbody id="watchlist-tbody">
                                        <tr>
                                            <td colspan="6" style="text-align: center; color: #64748b; padding: 20px;">
                                                ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="portfolio-card">
                            <h4>â• ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆè¿½åŠ </h4>
                            <form id="add-to-watchlist-form">
                                <div class="form-group">
                                    <label for="watch-ticker">éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ (4æ¡)</label>
                                    <input type="text" id="watch-ticker" maxlength="4" placeholder="7203" required>
                                </div>
                                <div class="form-group">
                                    <label for="watch-target-price">ç›®æ¨™ä¾¡æ ¼ (ä»»æ„)</label>
                                    <input type="number" id="watch-target-price" min="0" step="0.01" placeholder="3000">
                                </div>
                                <div class="form-group">
                                    <label for="watch-notes">ãƒ¡ãƒ¢ (ä»»æ„)</label>
                                    <textarea id="watch-notes" placeholder="æ³¨ç›®ç†ç”±ã‚„ãƒ¡ãƒ¢ã‚’è¨˜å…¥..."></textarea>
                                </div>
                                <div class="btn-group">
                                    <button type="submit" class="btn btn-primary">è¿½åŠ </button>
                                    <button type="button" class="btn btn-secondary" onclick="clearWatchForm()">ã‚¯ãƒªã‚¢</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Notes Tab -->
                <div id="notes" class="portfolio-tab-content">
                    <div class="portfolio-grid">
                        <div class="portfolio-card">
                            <h4>ğŸ“ æŠ•è³‡ãƒ¡ãƒ¢ä¸€è¦§</h4>
                            <div id="notes-container">
                                <div style="text-align: center; color: #64748b; padding: 20px;">
                                    ãƒ¡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...
                                </div>
                            </div>
                        </div>
                        
                        <div class="portfolio-card">
                            <h4>â• ãƒ¡ãƒ¢è¿½åŠ </h4>
                            <form id="add-note-form">
                                <div class="form-group">
                                    <label for="note-ticker">éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ (4æ¡)</label>
                                    <input type="text" id="note-ticker" maxlength="4" placeholder="7203" required>
                                </div>
                                <div class="form-group">
                                    <label for="note-title">ã‚¿ã‚¤ãƒˆãƒ«</label>
                                    <input type="text" id="note-title" placeholder="ãƒ¡ãƒ¢ã®ã‚¿ã‚¤ãƒˆãƒ«" required>
                                </div>
                                <div class="form-group">
                                    <label for="note-type">ã‚«ãƒ†ã‚´ãƒª</label>
                                    <select id="note-type">
                                        <option value="general">ä¸€èˆ¬</option>
                                        <option value="analysis">åˆ†æ</option>
                                        <option value="strategy">æˆ¦ç•¥</option>
                                        <option value="risk">ãƒªã‚¹ã‚¯</option>
                                        <option value="news">ãƒ‹ãƒ¥ãƒ¼ã‚¹</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="note-content">å†…å®¹</label>
                                    <textarea id="note-content" style="height: 120px;" placeholder="ãƒ¡ãƒ¢ã®å†…å®¹ã‚’è¨˜å…¥..." required></textarea>
                                </div>
                                <div class="btn-group">
                                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                                    <button type="button" class="btn btn-secondary" onclick="clearNoteForm()">ã‚¯ãƒªã‚¢</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- History Tab -->
                <div id="history" class="portfolio-tab-content">
                    <div class="portfolio-section">
                        <h4>ğŸ“ˆ åˆ†æãƒ»ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆå±¥æ­´</h4>
                        <div id="history-container">
                            <div style="text-align: center; color: #64748b; padding: 20px;">
                                å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...
                            </div>
                        </div>
                    </div>
                </div>
                
            </div>
        </div>
    </div>
    
    <script>
        async function analyzeStock() {
            console.log('åˆ†æé–‹å§‹');
            
            const ticker = document.getElementById('ticker').value;
            const period = document.getElementById('period').value;
            
            console.log('Ticker:', ticker, 'Period:', period);
            
            if (!ticker || ticker.length !== 4) {
                alert('4æ¡ã®éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            const loadingElement = document.getElementById('loading');
            loadingElement.style.display = 'inline';
            
            try {
                console.log('APIãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ä¸­...');
                
                const response = await fetch('/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ticker: ticker, 
                        period: period
                    })
                });
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('Response data:', result);
                
                if (result.success) {
                    displayResults(result.data);
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + result.error);
                    console.error('API Error:', result.error);
                }
            } catch (error) {
                console.error('Fetch Error:', error);
                alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            } finally {
                loadingElement.style.display = 'none';
            }
        }
        
        function displayResults(data) {
            console.log('çµæœè¡¨ç¤ºé–‹å§‹', data);
            
            try {
                document.getElementById('results').style.display = 'block';
                
                // ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«åˆ†æçµæœã®è¡¨ç¤º
                displayTechnicalAnalysis(data.technical || data);
                
                // é«˜åº¦ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«åˆ†æçµæœã®è¡¨ç¤ºï¼ˆPhase 3ï¼‰
                displayAdvancedTechnicalAnalysis(data.technical || data);
                
                // ãƒ•ã‚¡ãƒ³ãƒ€ãƒ¡ãƒ³ã‚¿ãƒ«åˆ†æçµæœã®è¡¨ç¤º
                if (data.fundamental) {
                    displayFundamentalAnalysis(data.fundamental, data.stock_info);
                }
                
                console.log('çµæœè¡¨ç¤ºå®Œäº†');
                
            } catch (error) {
                console.error('Display Error:', error);
                alert('çµæœè¡¨ç¤ºä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }
        
        function displayTechnicalAnalysis(data) {
            // ãƒãƒ£ãƒ¼ãƒˆæç”»
            if (data.chart_data) {
                const chartData = data.chart_data;
                const traces = [
                    {
                        x: chartData.dates,
                        y: chartData.prices,
                        type: 'scatter',
                        name: 'çµ‚å€¤',
                        line: {color: 'blue', width: 2}
                    }
                ];
                
                // ç§»å‹•å¹³å‡ç·šã‚’è¿½åŠ ï¼ˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆï¼‰
                if (chartData.sma_25 && chartData.sma_25.some(v => v != null)) {
                    traces.push({
                        x: chartData.dates,
                        y: chartData.sma_25,
                        type: 'scatter',
                        name: '25æ—¥ç§»å‹•å¹³å‡',
                        line: {color: 'green', width: 1}
                    });
                }
                
                if (chartData.sma_75 && chartData.sma_75.some(v => v != null)) {
                    traces.push({
                        x: chartData.dates,
                        y: chartData.sma_75,
                        type: 'scatter',
                        name: '75æ—¥ç§»å‹•å¹³å‡',
                        line: {color: 'red', width: 1}
                    });
                }
                
                const layout = {
                    title: {text: 'ğŸ“ˆ æ ªä¾¡ãƒãƒ£ãƒ¼ãƒˆï¼ˆåŸºæœ¬ï¼‰', font: {color: '#1e293b', size: 18}},
                    xaxis: {title: 'æ—¥ä»˜', color: '#475569'},
                    yaxis: {title: 'æ ªä¾¡ï¼ˆå††ï¼‰', color: '#475569'},
                    height: 500,
                    paper_bgcolor: 'rgba(255,255,255,0)',
                    plot_bgcolor: 'rgba(248, 250, 252, 0.8)',
                    font: {color: '#1e293b'},
                    legend: {
                        bgcolor: 'rgba(255, 255, 255, 0.9)',
                        bordercolor: '#cbd5e1',
                        borderwidth: 1
                    }
                };
                
                Plotly.newPlot('chart', traces, layout);
            }
            
            // ã‚·ã‚°ãƒŠãƒ«è¡¨ç¤º
            const signalsDiv = document.getElementById('signals');
            signalsDiv.innerHTML = '<h3>å£²è²·ã‚·ã‚°ãƒŠãƒ«</h3>';
            
            if (data.signals && data.signals.length > 0) {
                data.signals.forEach(signal => {
                    const div = document.createElement('div');
                    div.className = `signal-box ${signal.type}-signal`;
                    const typeText = signal.type === 'buy' ? 'ğŸ“ˆ è²·ã„' : signal.type === 'sell' ? 'ğŸ“‰ å£²ã‚Š' : 'ğŸ‘€ æ³¨ç›®';
                    const strengthIcon = signal.strength === 'strong' ? 'ğŸ”¥' : signal.strength === 'medium' ? 'âš¡' : 'ğŸ’¡';
                    div.innerHTML = `${strengthIcon} ${typeText}ã‚·ã‚°ãƒŠãƒ«: ${signal.reason}`;
                    signalsDiv.appendChild(div);
                });
            } else {
                signalsDiv.innerHTML += '<p style="color: #64748b;">ç¾åœ¨ã€æ˜ç¢ºãªå£²è²·ã‚·ã‚°ãƒŠãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
            }
            
            // RSIè¡¨ç¤º
            if (data.latest_rsi) {
                const rsiDiv = document.createElement('div');
                rsiDiv.innerHTML = `<p>ç¾åœ¨ã®RSI: ${data.latest_rsi.toFixed(2)}</p>`;
                signalsDiv.appendChild(rsiDiv);
            }
        }
        
        function displayAdvancedTechnicalAnalysis(data) {
            console.log('é«˜åº¦ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«åˆ†æè¡¨ç¤ºé–‹å§‹', data);
            
            // ãƒœãƒªãƒ³ã‚¸ãƒ£ãƒ¼ãƒãƒ³ãƒ‰ãƒãƒ£ãƒ¼ãƒˆ
            if (data.bollinger_data && data.chart_data) {
                const chartData = data.chart_data;
                const bbData = data.bollinger_data;
                
                const bbTraces = [
                    {
                        x: chartData.dates,
                        y: chartData.prices,
                        type: 'scatter',
                        name: 'çµ‚å€¤',
                        line: {color: '#74b9ff', width: 2}
                    },
                    {
                        x: chartData.dates,
                        y: bbData.upper,
                        type: 'scatter',
                        name: 'ãƒœãƒªãƒ³ã‚¸ãƒ£ãƒ¼ä¸Šé™',
                        line: {color: '#fd79a8', width: 1},
                        fill: 'tonexty'
                    },
                    {
                        x: chartData.dates,
                        y: bbData.middle,
                        type: 'scatter',
                        name: 'ãƒœãƒªãƒ³ã‚¸ãƒ£ãƒ¼ä¸­å¤®',
                        line: {color: '#fdcb6e', width: 1}
                    },
                    {
                        x: chartData.dates,
                        y: bbData.lower,
                        type: 'scatter',
                        name: 'ãƒœãƒªãƒ³ã‚¸ãƒ£ãƒ¼ä¸‹é™',
                        line: {color: '#fd79a8', width: 1},
                        fill: 'tonexty'
                    }
                ];
                
                const bbLayout = {
                    title: {text: 'ğŸ¯ ãƒœãƒªãƒ³ã‚¸ãƒ£ãƒ¼ãƒãƒ³ãƒ‰', font: {color: '#1e293b'}},
                    xaxis: {title: 'æ—¥ä»˜', color: '#475569'},
                    yaxis: {title: 'æ ªä¾¡ï¼ˆå††ï¼‰', color: '#475569'},
                    height: 350,
                    paper_bgcolor: 'rgba(255,255,255,0)',
                    plot_bgcolor: 'rgba(248, 250, 252, 0.8)',
                    font: {color: '#1e293b'}
                };
                
                Plotly.newPlot('bollinger-chart', bbTraces, bbLayout);
            }
            
            // MACDãƒãƒ£ãƒ¼ãƒˆ
            if (data.macd_data && data.chart_data) {
                const macdData = data.macd_data;
                const chartData = data.chart_data;
                
                const macdTraces = [
                    {
                        x: chartData.dates,
                        y: macdData.macd,
                        type: 'scatter',
                        name: 'MACD',
                        line: {color: '#00b894', width: 2}
                    },
                    {
                        x: chartData.dates,
                        y: macdData.signal,
                        type: 'scatter',
                        name: 'ã‚·ã‚°ãƒŠãƒ«',
                        line: {color: '#e17055', width: 2}
                    },
                    {
                        x: chartData.dates,
                        y: macdData.histogram,
                        type: 'bar',
                        name: 'ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ',
                        marker: {color: '#6c5ce7'}
                    }
                ];
                
                const macdLayout = {
                    title: {text: 'ğŸ“Š MACD', font: {color: '#1e293b'}},
                    xaxis: {title: 'æ—¥ä»˜', color: '#475569'},
                    yaxis: {title: 'MACDå€¤', color: '#475569'},
                    height: 350,
                    paper_bgcolor: 'rgba(255,255,255,0)',
                    plot_bgcolor: 'rgba(248, 250, 252, 0.8)',
                    font: {color: '#1e293b'}
                };
                
                Plotly.newPlot('macd-chart', macdTraces, macdLayout);
            }
            
            // ã‚¹ãƒˆã‚­ãƒ£ã‚¹ãƒ†ã‚£ã‚¯ã‚¹ãƒãƒ£ãƒ¼ãƒˆ
            if (data.stoch_data && data.chart_data) {
                const stochData = data.stoch_data;
                const chartData = data.chart_data;
                
                const stochTraces = [
                    {
                        x: chartData.dates,
                        y: stochData.k,
                        type: 'scatter',
                        name: '%K',
                        line: {color: '#a29bfe', width: 2}
                    },
                    {
                        x: chartData.dates,
                        y: stochData.d,
                        type: 'scatter',
                        name: '%D',
                        line: {color: '#fd79a8', width: 2}
                    }
                ];
                
                // è²·ã‚ã‚Œã™ããƒ»å£²ã‚‰ã‚Œã™ããƒ©ã‚¤ãƒ³ã‚’è¿½åŠ 
                stochTraces.push(
                    {
                        x: chartData.dates,
                        y: Array(chartData.dates.length).fill(80),
                        type: 'scatter',
                        name: 'è²·ã‚ã‚Œã™ã(80)',
                        line: {color: '#e74c3c', width: 1, dash: 'dash'},
                        showlegend: false
                    },
                    {
                        x: chartData.dates,
                        y: Array(chartData.dates.length).fill(20),
                        type: 'scatter',
                        name: 'å£²ã‚‰ã‚Œã™ã(20)',
                        line: {color: '#2ecc71', width: 1, dash: 'dash'},
                        showlegend: false
                    }
                );
                
                const stochLayout = {
                    title: {text: 'âš¡ ã‚¹ãƒˆã‚­ãƒ£ã‚¹ãƒ†ã‚£ã‚¯ã‚¹', font: {color: '#1e293b'}},
                    xaxis: {title: 'æ—¥ä»˜', color: '#475569'},
                    yaxis: {title: 'ã‚¹ãƒˆã‚­ãƒ£ã‚¹å€¤(%)', color: '#475569', range: [0, 100]},
                    height: 350,
                    paper_bgcolor: 'rgba(255,255,255,0)',
                    plot_bgcolor: 'rgba(248, 250, 252, 0.8)',
                    font: {color: '#1e293b'}
                };
                
                Plotly.newPlot('stoch-chart', stochTraces, stochLayout);
            }
            
            // å‡ºæ¥é«˜ãƒãƒ£ãƒ¼ãƒˆ
            if (data.volume_data && data.chart_data) {
                const volumeData = data.volume_data;
                const chartData = data.chart_data;
                
                const volumeTraces = [
                    {
                        x: chartData.dates,
                        y: volumeData.volume,
                        type: 'bar',
                        name: 'å‡ºæ¥é«˜',
                        marker: {color: '#74b9ff'}
                    },
                    {
                        x: chartData.dates,
                        y: volumeData.volume_sma,
                        type: 'scatter',
                        name: 'å‡ºæ¥é«˜ç§»å‹•å¹³å‡',
                        line: {color: '#fd79a8', width: 2}
                    }
                ];
                
                const volumeLayout = {
                    title: {text: 'ğŸ“ˆ å‡ºæ¥é«˜åˆ†æ', font: {color: '#1e293b'}},
                    xaxis: {title: 'æ—¥ä»˜', color: '#475569'},
                    yaxis: {title: 'å‡ºæ¥é«˜', color: '#475569'},
                    height: 350,
                    paper_bgcolor: 'rgba(255,255,255,0)',
                    plot_bgcolor: 'rgba(248, 250, 252, 0.8)',
                    font: {color: '#1e293b'}
                };
                
                Plotly.newPlot('volume-chart', volumeTraces, volumeLayout);
            }
            
            // é«˜åº¦ã‚·ã‚°ãƒŠãƒ«è¡¨ç¤º
            const advSignalsDiv = document.getElementById('advanced-signals');
            advSignalsDiv.innerHTML = '<h3 style="color: #475569;">ğŸš€ é«˜åº¦ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«ã‚·ã‚°ãƒŠãƒ«</h3>';
            
            let allSignals = [];
            
            // å„æŒ‡æ¨™ã®ã‚·ã‚°ãƒŠãƒ«ã‚’çµ±åˆ
            if (data.bollinger_data && data.bollinger_data.signals) {
                allSignals = allSignals.concat(data.bollinger_data.signals);
            }
            if (data.macd_data && data.macd_data.signals) {
                allSignals = allSignals.concat(data.macd_data.signals);
            }
            if (data.volume_data && data.volume_data.signals) {
                allSignals = allSignals.concat(data.volume_data.signals);
            }
            if (data.stoch_data && data.stoch_data.signals) {
                allSignals = allSignals.concat(data.stoch_data.signals);
            }
            
            if (allSignals.length > 0) {
                allSignals.forEach(signal => {
                    const div = document.createElement('div');
                    div.className = `signal-box ${signal.type}-signal`;
                    const typeText = signal.type === 'buy' ? 'ğŸ“ˆ è²·ã„' : signal.type === 'sell' ? 'ğŸ“‰ å£²ã‚Š' : 'ğŸ‘€ æ³¨ç›®';
                    const strengthIcon = signal.strength === 'strong' ? 'ğŸ”¥' : signal.strength === 'medium' ? 'âš¡' : 'ğŸ’¡';
                    div.innerHTML = `${strengthIcon} ${typeText}ã‚·ã‚°ãƒŠãƒ«: ${signal.reason}`;
                    advSignalsDiv.appendChild(div);
                });
            } else {
                advSignalsDiv.innerHTML += '<p style="color: #64748b;">ç¾åœ¨ã€é«˜åº¦ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«ã‚·ã‚°ãƒŠãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
            }
        }
        
        function displayFundamentalAnalysis(fundamental, stockInfo) {
            const fundamentalDiv = document.getElementById('fundamental-analysis');
            
            if (fundamental.error) {
                fundamentalDiv.innerHTML = `<h3>ãƒ•ã‚¡ãƒ³ãƒ€ãƒ¡ãƒ³ã‚¿ãƒ«åˆ†æ</h3><p>ã‚¨ãƒ©ãƒ¼: ${fundamental.error}</p>`;
                return;
            }
            
            const stockName = stockInfo ? stockInfo.company_name : '';
            const currentPrice = stockInfo ? stockInfo.current_price : 0;
            
            let html = `
                <h3>ğŸ“Š ãƒ•ã‚¡ãƒ³ãƒ€ãƒ¡ãƒ³ã‚¿ãƒ«åˆ†æ - ${stockName} (${currentPrice.toFixed(0)}å††)</h3>
                <div class="analysis-grid">
            `;
            
            // ãƒãƒªãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³åˆ†æ
            if (fundamental.valuation) {
                const val = fundamental.valuation;
                html += `
                    <div class="analysis-card">
                        <h4>ğŸ’° ãƒãƒªãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³</h4>
                        <div class="metric-row">
                            <span class="metric-label">PER:</span>
                            <span class="metric-value">${val.per ? val.per.toFixed(2) + 'å€' : 'ãƒ‡ãƒ¼ã‚¿ãªã—'}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">PBR:</span>
                            <span class="metric-value">${val.pbr ? val.pbr.toFixed(2) + 'å€' : 'ãƒ‡ãƒ¼ã‚¿ãªã—'}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">PERè©•ä¾¡:</span>
                            <span class="metric-value ${getRatingClass(val.per_rating)}">${val.per_rating}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">PBRè©•ä¾¡:</span>
                            <span class="metric-value ${getRatingClass(val.pbr_rating)}">${val.pbr_rating}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">ç·åˆè©•ä¾¡:</span>
                            <span class="metric-value ${getRatingClass(val.overall_rating)}">${val.overall_rating}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">æ™‚ä¾¡ç·é¡:</span>
                            <span class="metric-value">${val.market_cap_billion ? val.market_cap_billion.toFixed(0) + 'å…†å††' : 'ãƒ‡ãƒ¼ã‚¿ãªã—'}</span>
                        </div>
                    </div>
                `;
            }
            
            // é©æ­£æ ªä¾¡åˆ†æ
            if (fundamental.fair_value && fundamental.fair_value.fair_values) {
                const fv = fundamental.fair_value;
                html += `
                    <div class="analysis-card">
                        <h4>ğŸ¯ é©æ­£æ ªä¾¡</h4>
                `;
                
                if (fv.fair_values.per_based) {
                    html += `
                        <div class="metric-row">
                            <span class="metric-label">PERãƒ™ãƒ¼ã‚¹:</span>
                            <span class="metric-value">${fv.fair_values.per_based.toFixed(0)}å††</span>
                        </div>
                    `;
                }
                
                if (fv.fair_values.pbr_based) {
                    html += `
                        <div class="metric-row">
                            <span class="metric-label">PBRãƒ™ãƒ¼ã‚¹:</span>
                            <span class="metric-value">${fv.fair_values.pbr_based.toFixed(0)}å††</span>
                        </div>
                    `;
                }
                
                if (fv.fair_values.average) {
                    const upside = fv.price_comparison.average_upside;
                    html += `
                        <div class="metric-row">
                            <span class="metric-label">å¹³å‡é©æ­£æ ªä¾¡:</span>
                            <span class="metric-value">${fv.fair_values.average.toFixed(0)}å††</span>
                        </div>
                        ${upside ? `
                        <div class="metric-row">
                            <span class="metric-label">ä¸Šæ˜‡ä½™åœ°:</span>
                            <span class="metric-value ${upside > 0 ? 'rating-positive' : 'rating-negative'}">${upside > 0 ? '+' : ''}${upside.toFixed(1)}%</span>
                        </div>
                        ` : ''}
                    `;
                }
                
                html += `</div>`;
            }
            
            // é…å½“åˆ†æ
            if (fundamental.dividend) {
                const div = fundamental.dividend;
                html += `
                    <div class="analysis-card">
                        <h4>ğŸ’ é…å½“åˆ†æ</h4>
                        <div class="metric-row">
                            <span class="metric-label">é…å½“åˆ©å›ã‚Š:</span>
                            <span class="metric-value">${div.dividend_yield ? div.dividend_yield.toFixed(2) + '%' : 'ãƒ‡ãƒ¼ã‚¿ãªã—'}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">é…å½“è©•ä¾¡:</span>
                            <span class="metric-value ${getRatingClass(div.yield_rating)}">${div.yield_rating}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">é…å½“æ€§å‘:</span>
                            <span class="metric-value">${div.payout_ratio ? div.payout_ratio.toFixed(1) + '%' : 'ãƒ‡ãƒ¼ã‚¿ãªã—'}</span>
                        </div>
                        ${div.dividend_growth ? `
                        <div class="metric-row">
                            <span class="metric-label">é…å½“æˆé•·ç‡:</span>
                            <span class="metric-value ${div.dividend_growth > 0 ? 'rating-positive' : 'rating-negative'}">${div.dividend_growth > 0 ? '+' : ''}${div.dividend_growth}%</span>
                        </div>
                        ` : ''}
                    </div>
                `;
            }
            
            // è²¡å‹™å¥å…¨æ€§
            if (fundamental.financial) {
                const fin = fundamental.financial;
                html += `
                    <div class="analysis-card">
                        <h4>ğŸ¦ è²¡å‹™å¥å…¨æ€§</h4>
                        <div class="metric-row">
                            <span class="metric-label">ROE:</span>
                            <span class="metric-value">${fin.roe ? fin.roe.toFixed(1) + '%' : 'ãƒ‡ãƒ¼ã‚¿ãªã—'}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">è² å‚µæ¯”ç‡:</span>
                            <span class="metric-value">${fin.debt_to_equity ? fin.debt_to_equity.toFixed(2) : 'ãƒ‡ãƒ¼ã‚¿ãªã—'}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">å–¶æ¥­åˆ©ç›Šç‡:</span>
                            <span class="metric-value">${fin.operating_margin ? fin.operating_margin.toFixed(1) + '%' : 'ãƒ‡ãƒ¼ã‚¿ãªã—'}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">è²¡å‹™ã‚¹ã‚³ã‚¢:</span>
                            <span class="metric-value">${fin.financial_score}/100</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">è²¡å‹™è©•ä¾¡:</span>
                            <span class="metric-value ${getRatingClass(fin.financial_rating)}">${fin.financial_rating}</span>
                        </div>
                    </div>
                `;
            }
            
            html += '</div>'; // analysis-gridçµ‚äº†
            
            // æŠ•è³‡åˆ¤æ–­
            if (fundamental.investment_advice) {
                const advice = fundamental.investment_advice;
                html += `
                    <div class="investment-advice">
                        <div class="advice-recommendation ${getRatingClass(advice.recommendation)}">
                            ğŸ¯ æŠ•è³‡åˆ¤æ–­: ${advice.recommendation}
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">ç·åˆã‚¹ã‚³ã‚¢:</span>
                            <span class="metric-value">${fundamental.total_score}/100</span>
                        </div>
                `;
                
                if (advice.reasoning && advice.reasoning.length > 0) {
                    html += `
                        <div class="advice-list">
                            <strong>ğŸ“ˆ ãƒã‚¸ãƒ†ã‚£ãƒ–è¦å› :</strong>
                            <ul>
                                ${advice.reasoning.map(reason => `<li>${reason}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
                
                if (advice.risks && advice.risks.length > 0) {
                    html += `
                        <div class="advice-list">
                            <strong>âš ï¸ ãƒªã‚¹ã‚¯è¦å› :</strong>
                            <ul>
                                ${advice.risks.map(risk => `<li>${risk}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
                
                if (advice.opportunities && advice.opportunities.length > 0) {
                    html += `
                        <div class="advice-list">
                            <strong>ğŸš€ æŠ•è³‡æ©Ÿä¼š:</strong>
                            <ul>
                                ${advice.opportunities.map(opp => `<li>${opp}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
                
                html += '</div>';
            }
            
            html += `<p style="text-align: right; color: #666; font-size: 12px;">åˆ†ææ—¥æ™‚: ${fundamental.analysis_date}</p>`;
            
            fundamentalDiv.innerHTML = html;
        }
        
        function getRatingClass(rating) {
            if (!rating) return '';
            
            const positiveRatings = ['å‰²å®‰', 'ã‚„ã‚„å‰²å®‰', 'è‰¯å¥½', 'å„ªç§€', 'è²·ã„æ¨å¥¨', 'ã‚„ã‚„è²·ã„', 'é«˜ã„', 'é©æ­£'];
            const negativeRatings = ['å‰²é«˜', 'ã‚„ã‚„å‰²é«˜', 'æ³¨æ„', 'å±é™º', 'å£²ã‚Šæ¨å¥¨', 'ã‚„ã‚„å£²ã‚Š', 'ä½ã„'];
            
            if (positiveRatings.some(r => rating.includes(r))) {
                return 'rating-positive';
            } else if (negativeRatings.some(r => rating.includes(r))) {
                return 'rating-negative';
            } else {
                return 'rating-neutral';
            }
        }
        
        function showTab(tabId) {
            // ã™ã¹ã¦ã®ã‚¿ãƒ–ã¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éè¡¨ç¤º
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // é¸æŠã•ã‚ŒãŸã‚¿ãƒ–ã¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤º
            event.target.classList.add('active');
            document.getElementById(tabId).classList.add('active');
            
            // ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã‚¿ãƒ–ãŒè¡¨ç¤ºã•ã‚ŒãŸã¨ãã«ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰
            if (tabId === 'portfolio-tab' && typeof loadPortfolioData === 'function') {
                loadPortfolioData();
            }
        }
        
        // ãƒ¡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã®ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ç®¡ç†
        const MEMO_STORAGE_KEY = 'stock_analysis_memo_data';
        
        // ãƒ¡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
        function saveMemoData() {
            const memoData = [];
            const rows = document.querySelectorAll('.memo-table tbody tr');
            
            rows.forEach(row => {
                const inputs = row.querySelectorAll('input');
                const ticker = inputs[0].value.trim();
                const name = inputs[1].value.trim();
                const memo = inputs[2].value.trim();
                
                if (ticker || name || memo) {
                    memoData.push({
                        ticker: ticker,
                        name: name,
                        memo: memo
                    });
                }
            });
            
            try {
                localStorage.setItem(MEMO_STORAGE_KEY, JSON.stringify(memoData));
                updateMemoStatus('ãƒ¡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ', true);
                console.log('ãƒ¡ãƒ¢ãƒ‡ãƒ¼ã‚¿ä¿å­˜å®Œäº†:', memoData);
            } catch (error) {
                console.error('ãƒ¡ãƒ¢ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                updateMemoStatus('ä¿å­˜ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', false);
            }
        }
        
        // ãƒ¡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        function loadMemoData() {
            try {
                const savedData = localStorage.getItem(MEMO_STORAGE_KEY);
                if (savedData) {
                    const memoData = JSON.parse(savedData);
                    const rows = document.querySelectorAll('.memo-table tbody tr');
                    
                    // ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ†ãƒ¼ãƒ–ãƒ«ã«å¾©å…ƒ
                    memoData.forEach((item, index) => {
                        if (index < rows.length) {
                            const inputs = rows[index].querySelectorAll('input');
                            inputs[0].value = item.ticker || '';
                            inputs[1].value = item.name || '';
                            inputs[2].value = item.memo || '';
                        }
                    });
                    
                    updateMemoStatus(`${memoData.length}ä»¶ã®ãƒ¡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`, true);
                    console.log('ãƒ¡ãƒ¢ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†:', memoData);
                } else {
                    updateMemoStatus('ä¿å­˜ã•ã‚ŒãŸãƒ¡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“', false);
                }
            } catch (error) {
                console.error('ãƒ¡ãƒ¢ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                updateMemoStatus('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', false);
            }
        }
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã‚’æ›´æ–°
        function updateMemoStatus(message, isSuccess) {
            const statusElement = document.getElementById('memo-status');
            statusElement.textContent = message;
            statusElement.className = isSuccess ? 'memo-status saved' : 'memo-status';
            
            // 3ç§’å¾Œã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
            setTimeout(() => {
                statusElement.textContent = '';
            }, 3000);
        }
        
        // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
        function addMemoEventListeners() {
            const inputs = document.querySelectorAll('.memo-table input');
            inputs.forEach(input => {
                input.addEventListener('input', () => {
                    // å°‘ã—é…å»¶ã•ã›ã¦ã‹ã‚‰ä¿å­˜ï¼ˆé€£ç¶šå…¥åŠ›æ™‚ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å¯¾ç­–ï¼‰
                    clearTimeout(input.saveTimeout);
                    input.saveTimeout = setTimeout(saveMemoData, 500);
                });
            });
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
        // ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆé–¢é€£ã®é–¢æ•°
        async function runBacktest() {
            console.log('ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆé–‹å§‹');
            
            const ticker = document.getElementById('ticker').value.trim();
            const startDate = document.getElementById('backtest-start-date').value;
            const endDate = document.getElementById('backtest-end-date').value;
            const strategy = document.getElementById('strategy-select').value;
            const initialCapital = parseInt(document.getElementById('initial-capital').value);
            
            console.log('è¨­å®šå€¤:', { ticker, startDate, endDate, strategy, initialCapital });
            
            if (!ticker) {
                alert('éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            if (!startDate || !endDate) {
                alert('æœŸé–“ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            const loadingElement = document.getElementById('backtest-loading');
            const resultsElement = document.getElementById('backtest-results');
            
            console.log('UIè¦ç´ ç¢ºèª:', { 
                loading: !!loadingElement, 
                results: !!resultsElement 
            });
            
            loadingElement.style.display = 'block';
            resultsElement.style.display = 'none';
            
            try {
                console.log('APIãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ä¸­...');
                
                const requestBody = {
                    ticker: ticker,
                    start_date: startDate,
                    end_date: endDate,
                    strategy: strategy,
                    initial_capital: initialCapital
                };
                
                console.log('ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£:', requestBody);
                
                const response = await fetch('/backtest', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });
                
                console.log('ãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡:', response.status, response.statusText);
                
                const data = await response.json();
                console.log('ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿:', data);
                
                if (data.success) {
                    console.log('ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆæˆåŠŸã€çµæœè¡¨ç¤ºé–‹å§‹');
                    displayBacktestResults(data.data);
                } else {
                    console.error('ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆå¤±æ•—:', data.error);
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error('ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            } finally {
                console.log('ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’éè¡¨ç¤º');
                loadingElement.style.display = 'none';
            }
        }
        
        function displayBacktestResults(data) {
            console.log('çµæœè¡¨ç¤ºé–‹å§‹, ãƒ‡ãƒ¼ã‚¿:', data);
            
            const resultsElement = document.getElementById('backtest-results');
            if (!resultsElement) {
                console.error('çµæœè¡¨ç¤ºè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            console.log('çµæœè¦ç´ ã‚’è¡¨ç¤º');
            resultsElement.style.display = 'block';
            
            try {
                // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚µãƒãƒªãƒ¼ã‚’è¡¨ç¤º
                console.log('ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚µãƒãƒªãƒ¼è¡¨ç¤º');
                displayPerformanceSummary(data.backtest_result);
                
                // ãƒãƒ£ãƒ¼ãƒˆã‚’è¡¨ç¤º
                console.log('ãƒãƒ£ãƒ¼ãƒˆè¡¨ç¤º');
                displayBacktestChart(data.chart_data);
                
                // å–å¼•å±¥æ­´ã‚’è¡¨ç¤º
                console.log('å–å¼•å±¥æ­´è¡¨ç¤º');
                displayTradesList(data.trades);
                
                // è©³ç´°æŒ‡æ¨™ã‚’è¡¨ç¤º
                console.log('è©³ç´°æŒ‡æ¨™è¡¨ç¤º');
                displayDetailedMetrics(data.detailed_metrics);
                
                // ã‚¹ãƒˆãƒ©ãƒ†ã‚¸ãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
                console.log('ã‚¹ãƒˆãƒ©ãƒ†ã‚¸ãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¡¨ç¤º');
                displayStrategyParams(data.strategy_info);
                
                console.log('ã™ã¹ã¦ã®çµæœè¡¨ç¤ºå®Œäº†');
            } catch (error) {
                console.error('çµæœè¡¨ç¤ºä¸­ã«ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        function displayPerformanceSummary(performance) {
            console.log('ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚µãƒãƒªãƒ¼é–¢æ•°é–‹å§‹, ãƒ‡ãƒ¼ã‚¿:', performance);
            const container = document.getElementById('performance-summary');
            
            if (!container) {
                console.error('performance-summaryè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            const cards = [
                {
                    title: 'ç·ãƒªã‚¿ãƒ¼ãƒ³',
                    value: (performance.performance.total_return_pct ?? 0).toFixed(2) + '%',
                    type: (performance.performance.total_return_pct ?? 0) > 0 ? 'positive' : 'negative'
                },
                {
                    title: 'å–å¼•å›æ•°',
                    value: performance.performance.total_trades,
                    type: 'neutral'
                },
                {
                    title: 'å‹ç‡',
                    value: (performance.performance.win_rate ?? 0).toFixed(1) + '%',
                    type: (performance.performance.win_rate ?? 0) > 50 ? 'positive' : 'negative'
                },
                {
                    title: 'ã‚·ãƒ£ãƒ¼ãƒ—ãƒ¬ã‚·ã‚ª',
                    value: performance.risk_metrics.sharpe_ratio?.toFixed(2) || 'N/A',
                    type: (performance.risk_metrics.sharpe_ratio || 0) > 1 ? 'positive' : 'negative'
                },
                {
                    title: 'æœ€å¤§ãƒ‰ãƒ­ãƒ¼ãƒ€ã‚¦ãƒ³',
                    value: (performance.risk_metrics.max_drawdown ?? 0).toFixed(2) + '%',
                    type: 'negative'
                },
                {
                    title: 'ãƒã‚¤&ãƒ›ãƒ¼ãƒ«ãƒ‰æ¯”è¼ƒ',
                    value: (performance.market_comparison.alpha ?? 0).toFixed(2) + '%',
                    type: (performance.market_comparison.alpha ?? 0) > 0 ? 'positive' : 'negative'
                }
            ];
            
            container.innerHTML = cards.map(card => `
                <div class="performance-card">
                    <h4>${card.title}</h4>
                    <div class="value ${card.type}">${card.value}</div>
                </div>
            `).join('');
            
            // ç·åˆè©•ä¾¡ã‚’è¡¨ç¤º
            try {
                console.log('ç·åˆè©•ä¾¡è¨ˆç®—é–‹å§‹');
                const overallRating = calculateOverallRating(performance);
                console.log('ç·åˆè©•ä¾¡çµæœ:', overallRating);
                
                const ratingContainer = document.getElementById('overall-rating');
                if (ratingContainer) {
                    ratingContainer.className = `overall-rating ${overallRating.ratingClass}`;
                    ratingContainer.innerHTML = `
                        <div>ğŸ† ç·åˆè©•ä¾¡: ${overallRating.rating}</div>
                        <div style="font-size: 14px; margin-top: 8px; font-weight: normal;">${overallRating.message}</div>
                        <div style="font-size: 12px; margin-top: 8px; font-weight: normal;">
                            ${overallRating.factors.length > 0 ? 'è©•ä¾¡è¦å› : ' + overallRating.factors.join('ã€') : ''}
                        </div>
                    `;
                    console.log('ç·åˆè©•ä¾¡è¡¨ç¤ºå®Œäº†');
                } else {
                    console.error('overall-ratingè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
            } catch (error) {
                console.error('ç·åˆè©•ä¾¡è¡¨ç¤ºã§ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        function displayBacktestChart(chartData) {
            try {
                console.log('ãƒãƒ£ãƒ¼ãƒˆæç”»é–‹å§‹, ãƒ‡ãƒ¼ã‚¿:', chartData);
                
                if (!chartData || !chartData.dates || !chartData.prices) {
                    console.error('ãƒãƒ£ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ãŒä¸æ­£ã§ã™:', chartData);
                    return;
                }
                
                const trace1 = {
                    x: chartData.dates,
                    y: chartData.prices,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'æ ªä¾¡',
                    line: { color: '#3b82f6', width: 2 }
                };
                
                const buyTrace = {
                    x: chartData.signals?.buy_dates || [],
                    y: chartData.signals?.buy_prices || [],
                    type: 'scatter',
                    mode: 'markers',
                    name: 'è²·ã„ã‚·ã‚°ãƒŠãƒ«',
                    marker: { color: '#10b981', size: 8, symbol: 'triangle-up' }
                };
                
                const sellTrace = {
                    x: chartData.signals?.sell_dates || [],
                    y: chartData.signals?.sell_prices || [],
                    type: 'scatter',
                    mode: 'markers',
                    name: 'å£²ã‚Šã‚·ã‚°ãƒŠãƒ«',
                    marker: { color: '#ef4444', size: 8, symbol: 'triangle-down' }
                };
                
                const layout = {
                    title: 'ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆçµæœ',
                    xaxis: { title: 'æ—¥ä»˜' },
                    yaxis: { title: 'ä¾¡æ ¼ (å††)' },
                    plot_bgcolor: '#ffffff',
                    paper_bgcolor: '#ffffff',
                    font: { color: '#1e293b' },
                    showlegend: true
                };
                
                console.log('Plotlyã§ãƒãƒ£ãƒ¼ãƒˆæç”»ä¸­');
                Plotly.newPlot('backtest-chart', [trace1, buyTrace, sellTrace], layout, {responsive: true});
                console.log('ãƒãƒ£ãƒ¼ãƒˆæç”»å®Œäº†');
            } catch (error) {
                console.error('ãƒãƒ£ãƒ¼ãƒˆæç”»ã§ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        function displayTradesList(trades) {
            const container = document.getElementById('trades-table');
            
            if (!trades || trades.length === 0) {
                container.innerHTML = '<p>å–å¼•å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            const tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ—¥</th>
                            <th>ã‚¨ã‚°ã‚¸ãƒƒãƒˆæ—¥</th>
                            <th>ã‚¨ãƒ³ãƒˆãƒªãƒ¼ä¾¡æ ¼</th>
                            <th>ã‚¨ã‚°ã‚¸ãƒƒãƒˆä¾¡æ ¼</th>
                            <th>æç›Š</th>
                            <th>æç›Šç‡</th>
                            <th>ä¿æœ‰æ—¥æ•°</th>
                            <th>ç†ç”±</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${trades.map(trade => `
                            <tr>
                                <td>${trade.entry_date}</td>
                                <td>${trade.exit_date}</td>
                                <td>Â¥${trade.entry_price.toLocaleString()}</td>
                                <td>Â¥${trade.exit_price.toLocaleString()}</td>
                                <td class="${trade.profit_loss > 0 ? 'profit' : 'loss'}">
                                    Â¥${trade.profit_loss.toLocaleString()}
                                </td>
                                <td class="${trade.profit_loss_pct > 0 ? 'profit' : 'loss'}">
                                    ${trade.profit_loss_pct.toFixed(2)}%
                                </td>
                                <td>${trade.holding_days}æ—¥</td>
                                <td>${trade.entry_reason} â†’ ${trade.exit_reason}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = tableHTML;
        }
        
        function displayDetailedMetrics(metrics) {
            const container = document.getElementById('detailed-metrics');
            
            const groups = [
                {
                    title: 'åŸºæœ¬çµ±è¨ˆ',
                    data: metrics.basic_stats,
                    format: {
                        total_return: (v) => `Â¥${v.toLocaleString()}`,
                        total_return_pct: (v) => `${v.toFixed(2)}%`,
                        win_rate: (v) => `${v.toFixed(1)}%`,
                        avg_return_per_trade: (v) => `Â¥${v.toLocaleString()}`,
                        avg_holding_days: (v) => `${v.toFixed(1)}æ—¥`
                    }
                },
                {
                    title: 'ãƒªã‚¹ã‚¯æŒ‡æ¨™',
                    data: metrics.risk_metrics,
                    format: {
                        max_drawdown: (v) => `${v.toFixed(2)}%`,
                        volatility: (v) => `${v.toFixed(2)}%`,
                        sharpe_ratio: (v) => v.toFixed(2),
                        sortino_ratio: (v) => v.toFixed(2),
                        var_95: (v) => `${v.toFixed(2)}%`
                    }
                },
                {
                    title: 'åç›Šæ€§æŒ‡æ¨™',
                    data: metrics.profitability_metrics,
                    format: {
                        gross_profit: (v) => `Â¥${v.toLocaleString()}`,
                        gross_loss: (v) => `Â¥${v.toLocaleString()}`,
                        profit_factor: (v) => v.toFixed(2),
                        payoff_ratio: (v) => v.toFixed(2),
                        expectancy: (v) => `Â¥${v.toLocaleString()}`
                    }
                }
            ];
            
            container.innerHTML = groups.map(group => `
                <div class="metric-group">
                    <h4>${group.title}</h4>
                    ${Object.entries(group.data || {}).map(([key, value]) => {
                        const formatter = group.format[key] || ((v) => v);
                        const displayKey = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        return `
                            <div class="metric-item">
                                <span class="metric-label">${displayKey}</span>
                                <span class="metric-value">${formatter(value)}</span>
                            </div>
                        `;
                    }).join('')}
                </div>
            `).join('');
        }
        
        function displayStrategyParams(strategyInfo) {
            const container = document.getElementById('strategy-parameters');
            
            container.innerHTML = `
                <div class="metric-group">
                    <h4>${strategyInfo.name}</h4>
                    <p style="margin-bottom: 15px; color: #64748b;">${strategyInfo.description}</p>
                    ${Object.entries(strategyInfo.params).map(([key, value]) => {
                        const displayKey = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        return `
                            <div class="metric-item">
                                <span class="metric-label">${displayKey}</span>
                                <span class="metric-value">${value}</span>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        function showSubTab(tabId) {
            // ã™ã¹ã¦ã®ã‚µãƒ–ã‚¿ãƒ–ã¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éè¡¨ç¤º
            document.querySelectorAll('.tab-sub').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.sub-tab-content').forEach(content => content.classList.remove('active'));
            
            // é¸æŠã•ã‚ŒãŸã‚¿ãƒ–ã¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤º
            event.target.classList.add('active');
            document.getElementById(tabId).classList.add('active');
        }
        
        // Portfolio Management Functions
        function showPortfolioTab(tabId) {
            // ã™ã¹ã¦ã®ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã‚¿ãƒ–ã¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éè¡¨ç¤º
            document.querySelectorAll('.portfolio-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.portfolio-tab-content').forEach(content => content.classList.remove('active'));
            
            // é¸æŠã•ã‚ŒãŸã‚¿ãƒ–ã¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤º
            event.target.classList.add('active');
            document.getElementById(tabId).classList.add('active');
            
            // ã‚¿ãƒ–ãŒè¡¨ç¤ºã•ã‚ŒãŸã¨ãã«ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰
            if (tabId === 'portfolio-holdings') {
                loadPortfolioData();
            } else if (tabId === 'watchlist') {
                loadWatchlistData();
            } else if (tabId === 'notes') {
                loadNotesData();
            } else if (tabId === 'history') {
                loadHistoryData();
            }
        }
        
        async function loadPortfolioData() {
            try {
                const response = await fetch('/api/portfolio/portfolio');
                const result = await response.json();
                
                if (result.success) {
                    displayPortfolioData(result.data.portfolio);
                    updatePortfolioSummary(result.data.summary);
                } else {
                    console.error('Portfolio data load error:', result.error);
                }
            } catch (error) {
                console.error('Failed to load portfolio data:', error);
            }
        }
        
        function displayPortfolioData(portfolio) {
            const tbody = document.getElementById('portfolio-tbody');
            
            if (!portfolio || portfolio.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; color: #64748b; padding: 20px;">
                            ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã«éŠ˜æŸ„ãŒã‚ã‚Šã¾ã›ã‚“
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = portfolio.map(item => {
                const profitLoss = item.profit_loss || 0;
                const profitLossPct = item.profit_loss_pct || 0;
                const profitClass = profitLoss >= 0 ? 'profit' : 'loss';
                
                return `
                    <tr>
                        <td>${item.ticker}</td>
                        <td>${item.company_name || ''}</td>
                        <td>${(item.shares || 0).toLocaleString()}</td>
                        <td>ï¿¥${(item.average_price || 0).toLocaleString()}</td>
                        <td>ï¿¥${(item.current_price || 0).toLocaleString()}</td>
                        <td class="${profitClass}">ï¿¥${profitLoss.toLocaleString()}</td>
                        <td class="${profitClass}">${profitLossPct.toFixed(2)}%</td>
                        <td>
                            <button class="btn btn-danger" style="font-size: 10px; padding: 4px 8px;" 
                                    onclick="removeFromPortfolio(${item.id})">å‰Šé™¤</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function updatePortfolioSummary(summary) {
            document.getElementById('total-stocks').textContent = summary.total_stocks || 0;
            document.getElementById('total-investment').textContent = `ï¿¥${(summary.total_investment || 0).toLocaleString()}`;
            document.getElementById('current-value').textContent = `ï¿¥${(summary.current_value || 0).toLocaleString()}`;
            
            const profitLoss = summary.total_profit_loss || 0;
            const profitLossPct = summary.total_profit_loss_pct || 0;
            const profitClass = profitLoss >= 0 ? 'positive' : 'negative';
            
            const profitLossElement = document.getElementById('total-profit-loss');
            const profitLossPctElement = document.getElementById('total-profit-loss-pct');
            
            profitLossElement.textContent = `ï¿¥${profitLoss.toLocaleString()}`;
            profitLossElement.className = `value ${profitClass}`;
            
            profitLossPctElement.textContent = `${profitLossPct.toFixed(2)}%`;
            profitLossPctElement.className = `value ${profitClass}`;
        }
        
        async function loadWatchlistData() {
            try {
                const response = await fetch('/api/portfolio/watchlist');
                const result = await response.json();
                
                if (result.success) {
                    displayWatchlistData(result.data);
                } else {
                    console.error('Watchlist data load error:', result.error);
                }
            } catch (error) {
                console.error('Failed to load watchlist data:', error);
            }
        }
        
        function displayWatchlistData(watchlist) {
            const tbody = document.getElementById('watchlist-tbody');
            
            if (!watchlist || watchlist.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; color: #64748b; padding: 20px;">
                            ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆã«éŠ˜æŸ„ãŒã‚ã‚Šã¾ã›ã‚“
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = watchlist.map(item => {
                const targetPrice = item.target_price ? `ï¿¥${item.target_price.toLocaleString()}` : '-';
                const alertEnabled = item.alert_enabled ? 'âœ…' : 'âŒ';
                const dateAdded = new Date(item.date_added).toLocaleDateString('ja-JP');
                
                return `
                    <tr>
                        <td>${item.ticker}</td>
                        <td>${item.company_name || ''}</td>
                        <td>${targetPrice}</td>
                        <td>${alertEnabled}</td>
                        <td>${dateAdded}</td>
                        <td>
                            <button class="btn btn-danger" style="font-size: 10px; padding: 4px 8px;" 
                                    onclick="removeFromWatchlist(${item.id})">å‰Šé™¤</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        async function loadNotesData() {
            try {
                const response = await fetch('/api/portfolio/notes');
                const result = await response.json();
                
                if (result.success) {
                    displayNotesData(result.data);
                } else {
                    console.error('Notes data load error:', result.error);
                }
            } catch (error) {
                console.error('Failed to load notes data:', error);
            }
        }
        
        function displayNotesData(notes) {
            const container = document.getElementById('notes-container');
            
            if (!notes || notes.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #64748b; padding: 20px;">
                        ãƒ¡ãƒ¢ãŒã‚ã‚Šã¾ã›ã‚“
                    </div>
                `;
                return;
            }
            
            container.innerHTML = notes.map(note => {
                const dateCreated = new Date(note.date_created).toLocaleDateString('ja-JP');
                const noteTypeColors = {
                    'general': '#6b7280',
                    'analysis': '#3b82f6',
                    'strategy': '#10b981',
                    'risk': '#ef4444',
                    'news': '#f59e0b'
                };
                const typeColor = noteTypeColors[note.note_type] || '#6b7280';
                
                return `
                    <div class="note-item">
                        <div class="note-header">
                            <div>
                                <div class="note-title">${note.title}</div>
                                <div class="note-meta">
                                    ${note.ticker} | 
                                    <span style="color: ${typeColor}; font-weight: bold;">${note.note_type}</span> | 
                                    ${dateCreated}
                                </div>
                            </div>
                            <button class="btn btn-danger" style="font-size: 10px; padding: 4px 8px;" 
                                    onclick="archiveNote(${note.id})">å‰Šé™¤</button>
                        </div>
                        <div class="note-content">${note.content}</div>
                    </div>
                `;
            }).join('');
        }
        
        async function loadHistoryData() {
            try {
                const [analysisResponse, backtestResponse] = await Promise.all([
                    fetch('/api/portfolio/analysis-history?limit=20'),
                    fetch('/api/portfolio/backtest-history?limit=20')
                ]);
                
                const analysisResult = await analysisResponse.json();
                const backtestResult = await backtestResponse.json();
                
                const allHistory = [];
                
                if (analysisResult.success) {
                    allHistory.push(...analysisResult.data.map(item => ({...item, type: 'analysis'})));
                }
                
                if (backtestResult.success) {
                    allHistory.push(...backtestResult.data.map(item => ({...item, type: 'backtest'})));
                }
                
                // æ—¥ä»˜ã§ã‚½ãƒ¼ãƒˆ
                allHistory.sort((a, b) => new Date(b.date_created) - new Date(a.date_created));
                
                displayHistoryData(allHistory);
                
            } catch (error) {
                console.error('Failed to load history data:', error);
            }
        }
        
        function displayHistoryData(history) {
            const container = document.getElementById('history-container');
            
            if (!history || history.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #64748b; padding: 20px;">
                        å±¥æ­´ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“
                    </div>
                `;
                return;
            }
            
            container.innerHTML = history.map(item => {
                const dateCreated = new Date(item.date_created).toLocaleDateString('ja-JP');
                let typeLabel = '';
                let summary = '';
                
                if (item.type === 'analysis') {
                    typeLabel = item.analysis_type === 'technical' ? 'Technical' : 'Fundamental';
                    summary = `${item.ticker} - ${item.analysis_type} analysis`;
                } else if (item.type === 'backtest') {
                    typeLabel = 'Backtest';
                    const returnPct = item.total_return_pct || 0;
                    summary = `${item.ticker} - ${item.strategy_name} (${returnPct.toFixed(2)}%)`;
                }
                
                return `
                    <div class="history-item">
                        <div class="history-header">
                            <div>
                                <span class="history-type ${item.analysis_type || 'backtest'}">${typeLabel}</span>
                                <strong>${summary}</strong>
                            </div>
                            <div class="note-meta">${dateCreated}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Form handling functions
        document.addEventListener('DOMContentLoaded', function() {
            // Portfolio form
            document.getElementById('add-to-portfolio-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const ticker = document.getElementById('add-ticker').value;
                const shares = parseInt(document.getElementById('add-shares').value);
                const price = parseFloat(document.getElementById('add-price').value);
                const notes = document.getElementById('add-notes').value;
                
                try {
                    const response = await fetch('/api/portfolio/portfolio', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            ticker: ticker,
                            shares: shares,
                            average_price: price,
                            notes: notes
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        alert('ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã«è¿½åŠ ã—ã¾ã—ãŸ');
                        clearAddForm();
                        loadPortfolioData();
                    } else {
                        alert('ã‚¨ãƒ©ãƒ¼: ' + result.error);
                    }
                } catch (error) {
                    alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                    console.error(error);
                }
            });
            
            // Watchlist form
            document.getElementById('add-to-watchlist-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const ticker = document.getElementById('watch-ticker').value;
                const targetPrice = parseFloat(document.getElementById('watch-target-price').value) || null;
                const notes = document.getElementById('watch-notes').value;
                
                try {
                    const response = await fetch('/api/portfolio/watchlist', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            ticker: ticker,
                            target_price: targetPrice,
                            notes: notes
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        alert('ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸ');
                        clearWatchForm();
                        loadWatchlistData();
                    } else {
                        alert('ã‚¨ãƒ©ãƒ¼: ' + result.error);
                    }
                } catch (error) {
                    alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                    console.error(error);
                }
            });
            
            // Notes form
            document.getElementById('add-note-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const ticker = document.getElementById('note-ticker').value;
                const title = document.getElementById('note-title').value;
                const noteType = document.getElementById('note-type').value;
                const content = document.getElementById('note-content').value;
                
                try {
                    const response = await fetch('/api/portfolio/notes', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            ticker: ticker,
                            title: title,
                            note_type: noteType,
                            content: content
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        alert('ãƒ¡ãƒ¢ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
                        clearNoteForm();
                        loadNotesData();
                    } else {
                        alert('ã‚¨ãƒ©ãƒ¼: ' + result.error);
                    }
                } catch (error) {
                    alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                    console.error(error);
                }
            });
            
            // Load portfolio data on page load if portfolio tab is active
            if (document.getElementById('portfolio-tab').classList.contains('active')) {
                loadPortfolioData();
            }
        });
        
        function clearAddForm() {
            document.getElementById('add-ticker').value = '';
            document.getElementById('add-shares').value = '';
            document.getElementById('add-price').value = '';
            document.getElementById('add-notes').value = '';
        }
        
        function clearWatchForm() {
            document.getElementById('watch-ticker').value = '';
            document.getElementById('watch-target-price').value = '';
            document.getElementById('watch-notes').value = '';
        }
        
        function clearNoteForm() {
            document.getElementById('note-ticker').value = '';
            document.getElementById('note-title').value = '';
            document.getElementById('note-type').value = 'general';
            document.getElementById('note-content').value = '';
        }
        
        async function removeFromPortfolio(portfolioId) {
            if (!confirm('ã“ã®éŠ˜æŸ„ã‚’ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/portfolio/portfolio/${portfolioId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('å‰Šé™¤ã—ã¾ã—ãŸ');
                    loadPortfolioData();
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + result.error);
                }
            } catch (error) {
                alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                console.error(error);
            }
        }
        
        async function removeFromWatchlist(watchlistId) {
            if (!confirm('ã“ã®éŠ˜æŸ„ã‚’ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/portfolio/watchlist/${watchlistId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('å‰Šé™¤ã—ã¾ã—ãŸ');
                    loadWatchlistData();
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + result.error);
                }
            } catch (error) {
                alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                console.error(error);
            }
        }
        
        async function archiveNote(noteId) {
            if (!confirm('ã“ã®ãƒ¡ãƒ¢ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/portfolio/notes/${noteId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('å‰Šé™¤ã—ã¾ã—ãŸ');
                    loadNotesData();
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + result.error);
                }
            } catch (error) {
                alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                console.error(error);
            }
        }
        
        // æ–°ã—ã„ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆUIç”¨é–¢æ•°
        function setPresetPeriod(days) {
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(endDate.getDate() - days);
            
            document.getElementById('backtest-end-date').value = endDate.toISOString().split('T')[0];
            document.getElementById('backtest-start-date').value = startDate.toISOString().split('T')[0];
        }
        
        function setCapital(amount) {
            document.getElementById('initial-capital').value = amount;
        }
        
        function showStrategyDescription() {
            const strategySelect = document.getElementById('strategy-select');
            const descriptionDiv = document.getElementById('strategy-description');
            
            const descriptions = {
                'combo': '<strong>è¤‡åˆæˆ¦ç•¥:</strong> RSIã€ç§»å‹•å¹³å‡ç·šã€MACDã€ãƒœãƒªãƒ³ã‚¸ãƒ£ãƒ¼ãƒãƒ³ãƒ‰ã‚’çµ„ã¿åˆã‚ã›ãŸç·åˆçš„ãªåˆ¤å®šã‚’è¡Œã„ã¾ã™ã€‚è¤‡æ•°ã®æŒ‡æ¨™ã‚’ä½¿ã†ã“ã¨ã§ã‚ˆã‚Šç²¾åº¦ã®é«˜ã„å£²è²·ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’ç‹™ã„ã¾ã™ã€‚ï¼ˆåˆå¿ƒè€…ã«ãŠã™ã™ã‚ï¼‰',
                'rsi': '<strong>RSIæˆ¦ç•¥:</strong> RSIãŒ30ä»¥ä¸‹ã§è²·ã„ã€70ä»¥ä¸Šã§å£²ã‚Šã®é€†å¼µã‚Šæˆ¦ç•¥ã€‚çŸ­æœŸçš„ãªè²·ã‚ã‚Œã™ããƒ»å£²ã‚‰ã‚Œã™ãã‚’ç‹™ã„ã¾ã™ã€‚ã‚·ãƒ³ãƒ—ãƒ«ã§ã™ãŒç›¸å ´ã«ã‚ˆã£ã¦ã¯æœ‰åŠ¹ã§ã™ã€‚',
                'golden_cross': '<strong>ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ã‚¯ãƒ­ã‚¹æˆ¦ç•¥:</strong> 25æ—¥ç§»å‹•å¹³å‡ç·šãŒ75æ—¥ç§»å‹•å¹³å‡ç·šã‚’ä¸ŠæŠœã‘ãŸã‚‰è²·ã„ã€ä¸‹æŠœã‘ãŸã‚‰å£²ã‚Šã®é †å¼µã‚Šæˆ¦ç•¥ã€‚ãƒˆãƒ¬ãƒ³ãƒ‰ã®è»¢æ›ç‚¹ã‚’æ‰ãˆã¾ã™ã€‚',
                'macd': '<strong>MACDæˆ¦ç•¥:</strong> MACDã¨ã‚·ã‚°ãƒŠãƒ«ç·šã®ã‚¯ãƒ­ã‚¹ã§å£²è²·åˆ¤æ–­ã‚’è¡Œã„ã¾ã™ã€‚ãƒˆãƒ¬ãƒ³ãƒ‰ã®å‹¢ã„ã¨è»¢æ›ç‚¹ã‚’åŒæ™‚ã«åˆ¤æ–­ã§ãã‚‹å„ªã‚ŒãŸæŒ‡æ¨™ã§ã™ã€‚',
                'bollinger': '<strong>ãƒœãƒªãƒ³ã‚¸ãƒ£ãƒ¼ãƒãƒ³ãƒ‰æˆ¦ç•¥:</strong> ä¾¡æ ¼ãŒãƒãƒ³ãƒ‰ã®ä¸Šé™ã«é”ã—ãŸã‚‰å£²ã‚Šã€ä¸‹é™ã«é”ã—ãŸã‚‰è²·ã„ã®é€†å¼µã‚Šæˆ¦ç•¥ã€‚çµ±è¨ˆçš„ãªä¾¡æ ¼ã®ç•°å¸¸å€¤ã‚’ç‹™ã„ã¾ã™ã€‚'
            };
            
            descriptionDiv.innerHTML = descriptions[strategySelect.value] || '';
        }
        
        function toggleResultsGuide() {
            const guide = document.getElementById('results-guide');
            const icon = document.getElementById('guide-toggle-icon');
            
            if (guide.style.display === 'none') {
                guide.style.display = 'block';
                icon.textContent = 'â–²';
            } else {
                guide.style.display = 'none';
                icon.textContent = 'â–¼';
            }
        }
        
        function calculateOverallRating(performance) {
            const basic = performance.performance || {};
            const risk = performance.risk_metrics || {};
            const market = performance.market_comparison || {};
            
            let score = 0;
            let factors = [];
            
            // ç·ãƒªã‚¿ãƒ¼ãƒ³ã®è©•ä¾¡
            const totalReturn = basic.total_return_pct || 0;
            if (totalReturn > 20) {
                score += 3;
                factors.push('é«˜ãƒªã‚¿ãƒ¼ãƒ³');
            } else if (totalReturn > 10) {
                score += 2;
                factors.push('è‰¯å¥½ãªãƒªã‚¿ãƒ¼ãƒ³');
            } else if (totalReturn > 0) {
                score += 1;
                factors.push('ãƒ—ãƒ©ã‚¹ãƒªã‚¿ãƒ¼ãƒ³');
            } else {
                factors.push('ãƒã‚¤ãƒŠã‚¹ãƒªã‚¿ãƒ¼ãƒ³');
            }
            
            // å‹ç‡ã®è©•ä¾¡
            const winRate = basic.win_rate || 0;
            if (winRate >= 70) {
                score += 3;
                factors.push('é«˜å‹ç‡');
            } else if (winRate >= 50) {
                score += 2;
                factors.push('è‰¯å¥½ãªå‹ç‡');
            } else if (winRate >= 30) {
                score += 1;
            }
            
            // æœ€å¤§ãƒ‰ãƒ­ãƒ¼ãƒ€ã‚¦ãƒ³ã®è©•ä¾¡
            const maxDrawdown = risk.max_drawdown || 0;
            if (maxDrawdown <= 5) {
                score += 3;
                factors.push('ä½ãƒªã‚¹ã‚¯');
            } else if (maxDrawdown <= 10) {
                score += 2;
                factors.push('é©åº¦ãªãƒªã‚¹ã‚¯');
            } else if (maxDrawdown <= 20) {
                score += 1;
            } else {
                factors.push('é«˜ãƒªã‚¹ã‚¯');
            }
            
            // ã‚·ãƒ£ãƒ¼ãƒ—ãƒ¬ã‚·ã‚ªã®è©•ä¾¡
            const sharpeRatio = risk.sharpe_ratio || 0;
            if (sharpeRatio >= 2) {
                score += 3;
                factors.push('å„ªç§€ãªãƒªã‚¹ã‚¯åŠ¹ç‡');
            } else if (sharpeRatio >= 1) {
                score += 2;
                factors.push('è‰¯å¥½ãªãƒªã‚¹ã‚¯åŠ¹ç‡');
            } else if (sharpeRatio >= 0.5) {
                score += 1;
            }
            
            // ãƒã‚¤&ãƒ›ãƒ¼ãƒ«ãƒ‰æ¯”è¼ƒ
            const alpha = market.alpha || 0;
            if (alpha > 5) {
                score += 2;
                factors.push('å¸‚å ´ã‚’å¤§å¹…ã«ä¸Šå›ã‚‹');
            } else if (alpha > 0) {
                score += 1;
                factors.push('å¸‚å ´ã‚’ä¸Šå›ã‚‹');
            }
            
            // è©•ä¾¡åˆ¤å®š
            let rating, ratingClass, message;
            if (score >= 10) {
                rating = 'å„ªç§€';
                ratingClass = 'excellent';
                message = 'ã“ã®æˆ¦ç•¥ã¯éå¸¸ã«å„ªç§€ãªçµæœã‚’ç¤ºã—ã¦ã„ã¾ã™ï¼';
            } else if (score >= 6) {
                rating = 'è‰¯å¥½';
                ratingClass = 'good';
                message = 'ã“ã®æˆ¦ç•¥ã¯è‰¯å¥½ãªçµæœã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚';
            } else {
                rating = 'è¦æ”¹å–„';
                ratingClass = 'poor';
                message = 'ã“ã®æˆ¦ç•¥ã¯æ”¹å–„ã®ä½™åœ°ãŒã‚ã‚Šã¾ã™ã€‚';
            }
            
            return {
                rating: rating,
                ratingClass: ratingClass,
                message: message,
                factors: factors,
                score: score
            };
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        window.addEventListener('load', function() {
            console.log('ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');
            loadMemoData();
            addMemoEventListeners();
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æ—¥ä»˜ã‚’è¨­å®šï¼ˆ6ãƒ¶æœˆå‰ã‹ã‚‰ç¾åœ¨ã¾ã§ï¼‰
            const endDate = new Date();
            const startDate = new Date();
            startDate.setMonth(endDate.getMonth() - 6);
            
            document.getElementById('backtest-end-date').value = endDate.toISOString().split('T')[0];
            document.getElementById('backtest-start-date').value = startDate.toISOString().split('T')[0];
            
            // æˆ¦ç•¥èª¬æ˜ã®åˆæœŸè¡¨ç¤º
            showStrategyDescription();
        });
    </script>
    
    </div> <!-- /main-content -->
</body>
</html>