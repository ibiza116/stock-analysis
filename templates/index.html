<!DOCTYPE html>
<!-- DEBUG: Template served from templates/index.html v7.0 - Timestamp: 2025-08-29 22:05:00 -->
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ªä¾¡åˆ†æãƒ„ãƒ¼ãƒ« - 3ã¤ã®ãƒ¢ãƒ¼ãƒ‰çµ±åˆç‰ˆ [v7.0]</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1a202c;
            color: #ffffff;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: #2d3748;
            border-radius: 10px;
        }
        
        .analysis-form {
            background: #2d3748;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .stock-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            background: #374151;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .stock-table th {
            background: #4a5568;
            color: #ffffff;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }
        
        .stock-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #4a5568;
        }
        
        .stock-table tr:last-child td {
            border-bottom: none;
        }
        
        .stock-table tr:hover {
            background: #4a5568;
        }
        
        .stock-checkbox {
            width: 18px;
            height: 18px;
            accent-color: #4299e1;
        }
        
        .select-all-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .select-btn {
            padding: 6px 12px;
            background: #4a5568;
            border: none;
            border-radius: 4px;
            color: #ffffff;
            cursor: pointer;
            font-size: 14px;
        }
        
        .select-btn:hover {
            background: #2d3748;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #a0aec0;
            font-weight: 500;
        }
        
        input[type="text"], select {
            width: 100%;
            padding: 12px;
            border: 1px solid #4a5568;
            border-radius: 5px;
            background: #374151;
            color: #ffffff;
            font-size: 16px;
        }
        
        button {
            background: #4299e1;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
        }
        
        button:hover {
            background: #3182ce;
        }
        
        .results-container {
            display: none;
        }
        
        .stock-card {
            background: #2d3748;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #4a5568;
        }
        
        .stock-header {
            font-size: 20px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .signals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .signal-item {
            background: #374151;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }
        
        .signal-label {
            display: block;
            color: #a0aec0;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .signal-value {
            font-weight: 600;
            font-size: 16px;
        }
        
        .signal-buy { color: #48bb78; }
        .signal-sell { color: #f56565; }
        .signal-neutral { color: #a0aec0; }
        
        .chart-container {
            background: #374151;
            border-radius: 8px;
            height: 400px;
            margin-top: 20px;
        }
        
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #a0aec0;
            font-size: 16px;
        }
        
        .error {
            color: #f56565;
            text-align: center;
            padding: 20px;
        }
        
        /* 3ã¤ã®ãƒ¢ãƒ¼ãƒ‰è¡¨ç¤ºæ©Ÿèƒ½ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .mode-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .mode-btn {
            background: #4a5568;
            color: #ffffff;
            border: 2px solid #4a5568;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            min-width: 120px;
        }
        
        .mode-btn:hover {
            background: #2d3748;
            border-color: #63b3ed;
            transform: translateY(-2px);
        }
        
        .mode-btn.active {
            background: #3182ce;
            border-color: #3182ce;
            box-shadow: 0 4px 12px rgba(49, 130, 206, 0.3);
        }
        
        .mode-content {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .backtest-form {
            background: #2d3748;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .backtest-form h3 {
            color: #63b3ed;
            margin-bottom: 15px;
        }
        
        .portfolio-card {
            background: #2d3748;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #48bb78;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“ˆ æ ªä¾¡åˆ†æãƒ„ãƒ¼ãƒ«</h1>
            <p style="color: #ff6b6b; font-weight: bold; margin-top: 10px;">
                ğŸ” DEBUG: v7.0çµ±åˆç‰ˆæ­£å¸¸å‹•ä½œä¸­ (2025-08-29 22:05) - 3ã¤ã®ãƒ¢ãƒ¼ãƒ‰æ©Ÿèƒ½çµ±åˆæ¸ˆã¿
            </p>
        <p>ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«ãƒ»ãƒ•ã‚¡ãƒ³ãƒ€ãƒ¡ãƒ³ã‚¿ãƒ«åˆ†æã¨ãƒãƒ£ãƒ¼ãƒˆè¡¨ç¤º</p>
    </div>

    <div class="analysis-form">
        <div class="input-group">
            <label>ğŸ“ˆ åˆ†æå¯¾è±¡éŠ˜æŸ„ã‚’é¸æŠ</label>
            
            <div class="select-all-controls">
                <button type="button" class="select-btn" onclick="selectAll()">ã™ã¹ã¦é¸æŠ</button>
                <button type="button" class="select-btn" onclick="selectNone()">é¸æŠè§£é™¤</button>
                <button type="button" class="select-btn" onclick="showAddStockForm()" style="background: #48bb78;">â• éŠ˜æŸ„è¿½åŠ </button>
                <button type="button" class="select-btn" onclick="toggleEditMode()" id="edit-mode-btn">âœï¸ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰</button>
            </div>
            
            <!-- éŠ˜æŸ„è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  -->
            <div id="add-stock-form" style="display: none; background: #4a5568; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                <h4 style="margin: 0 0 10px 0; color: #ffffff;">æ–°ã—ã„éŠ˜æŸ„ã‚’è¿½åŠ </h4>
                <div style="display: grid; grid-template-columns: 1fr 2fr 1fr auto; gap: 10px; align-items: end;">
                    <div>
                        <label style="font-size: 12px; color: #a0aec0;">éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰</label>
                        <input type="text" id="new-ticker" placeholder="ä¾‹: 1234" maxlength="4" style="width: 100%; padding: 8px; background: #374151; border: 1px solid #4a5568; color: #fff; border-radius: 4px;">
                    </div>
                    <div>
                        <label style="font-size: 12px; color: #a0aec0;">ä¼æ¥­å</label>
                        <input type="text" id="new-company" placeholder="ä¾‹: ã‚µãƒ³ãƒ—ãƒ«æ ªå¼ä¼šç¤¾" style="width: 100%; padding: 8px; background: #374151; border: 1px solid #4a5568; color: #fff; border-radius: 4px;">
                    </div>
                    <div>
                        <label style="font-size: 12px; color: #a0aec0;">æ¥­ç•Œ</label>
                        <input type="text" id="new-industry" placeholder="ä¾‹: ITãƒ»ã‚µãƒ¼ãƒ“ã‚¹" style="width: 100%; padding: 8px; background: #374151; border: 1px solid #4a5568; color: #fff; border-radius: 4px;">
                    </div>
                    <div>
                        <button type="button" onclick="addStock()" style="background: #48bb78; padding: 8px 16px;">è¿½åŠ </button>
                        <button type="button" onclick="hideAddStockForm()" style="background: #e53e3e; padding: 8px 16px; margin-left: 5px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    </div>
                </div>
            </div>
            
            <table class="stock-table">
                <thead>
                    <tr>
                        <th style="width: 50px;">é¸æŠ</th>
                        <th style="width: 80px;">ã‚³ãƒ¼ãƒ‰</th>
                        <th>ä¼æ¥­å</th>
                        <th>æ¥­ç•Œ</th>
                        <th id="delete-header" style="width: 60px; display: none;">å‰Šé™¤</th>
                    </tr>
                </thead>
                <tbody id="stock-table-body">
                    <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«è¡Œ -->
                </tbody>
            </table>
        </div>
        
        <div class="input-group">
            <label for="period">åˆ†ææœŸé–“</label>
            <select id="period">
                <option value="3mo">3ãƒ¶æœˆ</option>
                <option value="6mo" selected>6ãƒ¶æœˆ</option>
                <option value="1y">1å¹´</option>
            </select>
        </div>
        
        <button onclick="analyzeStock()" id="analyze-btn">åˆ†æå®Ÿè¡Œ</button>
    </div>

    <div id="results-container" class="results-container">
        <!-- åˆ†æçµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
    </div>

    <script>
        async function analyzeStock() {
            console.log('ğŸ” [DEBUG] analyzeStock function called');
            const periodElement = document.getElementById('period');
            if (!periodElement) {
                console.error('âŒ [DEBUG] Period element not found!');
                alert('æœŸé–“é¸æŠè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            const period = periodElement.value;
            console.log('ğŸ” [DEBUG] Period selected:', period);
            const button = document.getElementById('analyze-btn');
            const resultsContainer = document.getElementById('results-container');
            
            // ãƒã‚§ãƒƒã‚¯ã•ã‚ŒãŸéŠ˜æŸ„ã‚’å–å¾—
            console.log('ğŸ” [DEBUG] Getting checked checkboxes...');
            const checkboxes = document.querySelectorAll('.stock-checkbox:checked');
            console.log('ğŸ” [DEBUG] Found checkboxes:', checkboxes.length);
            const tickers = Array.from(checkboxes).map(cb => cb.value);
            console.log('ğŸ” [DEBUG] Selected tickers:', tickers);
            
            if (tickers.length === 0) {
                console.log('âŒ [DEBUG] No tickers selected');
                alert('åˆ†æã™ã‚‹éŠ˜æŸ„ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            console.log('âœ… [DEBUG] Validation passed, starting analysis...');
            
            if (tickers.length > 10) {
                alert('ä¸€åº¦ã«åˆ†æã§ãã‚‹ã®ã¯æœ€å¤§10éŠ˜æŸ„ã¾ã§ã§ã™');
                return;
            }
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹
            button.textContent = `${tickers.length}éŠ˜æŸ„åˆ†æä¸­...`;
            button.disabled = true;
            resultsContainer.style.display = 'block';
            resultsContainer.innerHTML = '<div class="loading">ğŸ“Š è¤‡æ•°éŠ˜æŸ„ã‚’ä¸¦åˆ—åˆ†æä¸­...</div>';
            
            try {
                console.log(`ğŸš€ Starting parallel analysis for ${tickers.length} tickers:`, tickers);
                
                // ä¸¦åˆ—ã§APIãƒªã‚¯ã‚¨ã‚¹ãƒˆå®Ÿè¡Œ
                const analysisPromises = tickers.map(async ticker => {
                    try {
                        const response = await fetch('/analyze', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                ticker: ticker,
                                period: period
                            })
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            return { ticker, data: result.data, success: true };
                        } else {
                            throw new Error(result.error || 'Analysis failed');
                        }
                    } catch (error) {
                        console.error(`âŒ Analysis failed for ${ticker}:`, error);
                        return { ticker, error: error.message, success: false };
                    }
                });
                
                // ã™ã¹ã¦ã®åˆ†æãŒå®Œäº†ã™ã‚‹ã¾ã§å¾…æ©Ÿ
                const results = await Promise.all(analysisPromises);
                console.log('ğŸ“Š All analysis completed:', results);
                
                // çµæœã‚’è¡¨ç¤º
                displayMultipleResults(results);
                
            } catch (error) {
                console.error('âŒ Analysis error:', error);
                resultsContainer.innerHTML = `<div class="error">âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
            } finally {
                button.textContent = 'åˆ†æå®Ÿè¡Œ';
                button.disabled = false;
            }
        }
        
        function displayMultipleResults(results) {
            const resultsContainer = document.getElementById('results-container');
            
            // æˆåŠŸã¨å¤±æ•—ã‚’åˆ†ã‘ã‚‹
            const successful = results.filter(r => r.success);
            const failed = results.filter(r => !r.success);
            
            let html = '';
            
            // çµ±è¨ˆæƒ…å ±
            if (results.length > 1) {
                html += `
                    <div style="background: #2d3748; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
                        <h3 style="margin: 0; color: #ffffff;">ğŸ“Š åˆ†æã‚µãƒãƒªãƒ¼</h3>
                        <p style="margin: 5px 0; color: #a0aec0;">
                            æˆåŠŸ: ${successful.length}éŠ˜æŸ„ | å¤±æ•—: ${failed.length}éŠ˜æŸ„ | åˆè¨ˆ: ${results.length}éŠ˜æŸ„
                        </p>
                    </div>
                `;
            }
            
            // æˆåŠŸã—ãŸåˆ†æçµæœã‚’è¡¨ç¤º
            successful.forEach(result => {
                const { ticker, data } = result;
                const { technical, fundamental, stock_info } = data;
                
                // ã‚·ã‚°ãƒŠãƒ«æƒ…å ±ã‚’å–å¾—
                const rsiSignal = technical.signals?.rsi_signal || technical.rsi_signal || 'neutral';
                const maSignal = technical.signals?.ma_signal || technical.ma_signal || 'neutral';
                const goldenCross = technical.signals?.golden_cross || technical.golden_cross || false;
                const fundamentalScore = fundamental.overall_assessment?.total_score || 0;
                const recommendation = fundamental.overall_assessment?.recommendation || 'hold';
                
                html += `
                    <div class="stock-card">
                        <div class="stock-header">
                            ğŸ“ˆ ${ticker} - ${stock_info.company_name || ''}
                            <span style="margin-left: auto; font-size: 18px;">ç¾åœ¨ä¾¡æ ¼: Â¥${(stock_info.current_price || 0).toLocaleString()}</span>
                        </div>
                        
                        <div class="signals-grid">
                            <div class="signal-item">
                                <span class="signal-label">RSI (${technical.latest_rsi?.toFixed(1) || 'N/A'})</span>
                                <span class="signal-value signal-${rsiSignal}">${getSignalText(rsiSignal)}</span>
                            </div>
                            
                            <div class="signal-item">
                                <span class="signal-label">ç§»å‹•å¹³å‡ç·š</span>
                                <span class="signal-value signal-${maSignal}">${getSignalText(maSignal)}</span>
                            </div>
                            
                            <div class="signal-item">
                                <span class="signal-label">ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ã‚¯ãƒ­ã‚¹</span>
                                <span class="signal-value signal-${goldenCross ? 'buy' : 'neutral'}">${goldenCross ? 'ç™ºç”Ÿä¸­' : 'ãªã—'}</span>
                            </div>
                            
                            <div class="signal-item">
                                <span class="signal-label">ãƒ•ã‚¡ãƒ³ãƒ€ãƒ¡ãƒ³ã‚¿ãƒ«ã‚¹ã‚³ã‚¢</span>
                                <span class="signal-value signal-${getScoreColor(fundamentalScore)}">${fundamentalScore}/100</span>
                            </div>
                            
                            <div class="signal-item">
                                <span class="signal-label">æŠ•è³‡åˆ¤æ–­</span>
                                <span class="signal-value signal-${recommendation === 'buy' ? 'buy' : recommendation === 'sell' ? 'sell' : 'neutral'}">${getRecommendationText(recommendation)}</span>
                            </div>
                        </div>
                        
                        <div class="chart-container" id="chart-${ticker}">
                            <div class="loading">ğŸ“Š ãƒãƒ£ãƒ¼ãƒˆä½œæˆä¸­...</div>
                        </div>
                    </div>
                `;
            });
            
            // å¤±æ•—ã—ãŸåˆ†æçµæœã‚’è¡¨ç¤º
            failed.forEach(result => {
                html += `
                    <div class="stock-card" style="border: 1px solid #f56565;">
                        <div class="stock-header" style="color: #f56565;">
                            âŒ ${result.ticker} - åˆ†æå¤±æ•—
                        </div>
                        <div class="error" style="margin: 10px 0;">
                            ã‚¨ãƒ©ãƒ¼: ${result.error}
                        </div>
                    </div>
                `;
            });
            
            // 3ã¤ã®ãƒ¢ãƒ¼ãƒ‰è¡¨ç¤ºæ©Ÿèƒ½ã‚’è¿½åŠ 
            const modeButtonsHtml = `
                <div class="mode-buttons" style="margin: 20px 0; text-align: center;">
                    <button onclick="showInvestmentMode()" class="mode-btn active" id="investment-mode-btn">
                        ğŸ“Š æŠ•è³‡åˆ¤æ–­
                    </button>
                    <button onclick="showSwingMode()" class="mode-btn" id="swing-mode-btn">
                        ğŸ“ˆ ã‚¹ã‚¤ãƒ³ã‚°åˆ†æ
                    </button>
                    <button onclick="showBacktestMode()" class="mode-btn" id="backtest-mode-btn">
                        âš¡ ãƒ†ã‚¹ãƒˆçµæœ
                    </button>
                    <button onclick="showPortfolioMode()" class="mode-btn" id="portfolio-mode-btn">
                        ğŸ’¼ ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ª
                    </button>
                </div>
                
                <div id="investment-content" class="mode-content">${html}</div>
                <div id="swing-content" class="mode-content" style="display: none;">
                    <div class="loading">ğŸ“ˆ ã‚¹ã‚¤ãƒ³ã‚°åˆ†æãƒãƒ£ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
                </div>
                <div id="backtest-content" class="mode-content" style="display: none;">
                    <div class="loading">âš¡ ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
                </div>
                <div id="portfolio-content" class="mode-content" style="display: none;">
                    <div class="loading">ğŸ’¼ ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
                </div>
            `;
            
            resultsContainer.innerHTML = modeButtonsHtml;
            
            // æˆåŠŸã—ãŸéŠ˜æŸ„ã®ãƒãƒ£ãƒ¼ãƒˆã‚’é †æ¬¡ä½œæˆï¼ˆæŠ•è³‡åˆ¤æ–­ãƒ¢ãƒ¼ãƒ‰ç”¨ï¼‰
            successful.forEach((result, index) => {
                setTimeout(() => {
                    console.log(`ğŸ¨ Creating chart for ${result.ticker} (${index + 1}/${successful.length})`);
                    createChart(result.ticker, result.data.technical);
                }, index * 200); // å°‘ã—é–“éš”ã‚’ç©ºã‘ã¦ãƒãƒ£ãƒ¼ãƒˆä½œæˆ
            });
            
            // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦åˆ†æçµæœã‚’ä¿å­˜
            window.currentAnalysisResults = { successful, failed };
        }
        
        // å˜ä¸€éŠ˜æŸ„ç”¨ã®æ—¢å­˜é–¢æ•°ã‚‚æ®‹ã™ï¼ˆäº’æ›æ€§ã®ãŸã‚ï¼‰
        function displayResults(ticker, data) {
            displayMultipleResults([{ ticker, data, success: true }]);
        }
        
        // 3ã¤ã®ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
        function showInvestmentMode() {
            console.log('ğŸ“Š Switching to Investment Mode');
            showModeContent('investment');
            setActiveButton('investment-mode-btn');
        }
        
        function showSwingMode() {
            console.log('ğŸ“ˆ Switching to Swing Analysis Mode');
            showModeContent('swing');
            setActiveButton('swing-mode-btn');
            loadSwingContent();
        }
        
        function showBacktestMode() {
            console.log('âš¡ Switching to Backtest Mode');
            showModeContent('backtest');
            setActiveButton('backtest-mode-btn');
            loadBacktestContent();
        }
        
        function showPortfolioMode() {
            console.log('ğŸ’¼ Switching to Portfolio Mode');
            showModeContent('portfolio');
            setActiveButton('portfolio-mode-btn');
            loadPortfolioContent();
        }
        
        function showModeContent(mode) {
            // å…¨ã¦ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éè¡¨ç¤º
            const contents = ['investment-content', 'swing-content', 'backtest-content', 'portfolio-content'];
            contents.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.style.display = 'none';
            });
            
            // é¸æŠã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤º
            const targetContent = document.getElementById(`${mode}-content`);
            if (targetContent) {
                targetContent.style.display = 'block';
            }
        }
        
        function setActiveButton(activeId) {
            // å…¨ã¦ã®ãƒœã‚¿ãƒ³ã‹ã‚‰activeã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
            const buttons = document.querySelectorAll('.mode-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            // é¸æŠã•ã‚ŒãŸãƒœã‚¿ãƒ³ã«activeã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
            const activeButton = document.getElementById(activeId);
            if (activeButton) {
                activeButton.classList.add('active');
            }
        }
        
        // ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„èª­ã¿è¾¼ã¿
        function loadBacktestContent() {
            const backtestContent = document.getElementById('backtest-content');
            if (!backtestContent) return;
            
            const currentResults = window.currentAnalysisResults;
            if (!currentResults || !currentResults.successful.length) {
                backtestContent.innerHTML = '<div class="error">âŒ åˆ†æçµæœãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«æ ªä¾¡åˆ†æã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</div>';
                return;
            }
            
            const firstTicker = currentResults.successful[0].ticker;
            const backtestHtml = `
                <div class="backtest-form">
                    <h3>âš¡ ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆè¨­å®š</h3>
                    <div class="input-group">
                        <label>å¯¾è±¡éŠ˜æŸ„:</label>
                        <select id="backtest-ticker">
                            ${currentResults.successful.map(result => 
                                `<option value="${result.ticker}">${result.ticker}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="input-group">
                        <label>æœŸé–“:</label>
                        <select id="backtest-period">
                            <option value="3mo">3ãƒ¶æœˆ</option>
                            <option value="6mo" selected>6ãƒ¶æœˆ</option>
                            <option value="1y">1å¹´</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>æˆ¦ç•¥:</label>
                        <select id="backtest-strategy">
                            <option value="rsi">RSIæˆ¦ç•¥</option>
                            <option value="ma_cross">ç§»å‹•å¹³å‡ã‚¯ãƒ­ã‚¹</option>
                            <option value="combo" selected>è¤‡åˆæˆ¦ç•¥</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>åˆæœŸè³‡é‡‘:</label>
                        <select id="backtest-capital">
                            <option value="500000">50ä¸‡å††</option>
                            <option value="1000000" selected>100ä¸‡å††</option>
                            <option value="3000000">300ä¸‡å††</option>
                        </select>
                    </div>
                    <button onclick="runBacktest()" class="analyze-btn">ğŸš€ ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
                </div>
                <div id="backtest-results">
                    <div class="info">ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆè¨­å®šã‚’é¸æŠã—ã¦å®Ÿè¡Œãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„</div>
                </div>
            `;
            backtestContent.innerHTML = backtestHtml;
        }
        
        // ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã‚³ãƒ³ãƒ†ãƒ³ãƒ„èª­ã¿è¾¼ã¿
        function loadPortfolioContent() {
            const portfolioContent = document.getElementById('portfolio-content');
            if (!portfolioContent) return;
            
            // ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªUIã®HTMLã‚’ç”Ÿæˆ
            const portfolioHtml = `
                <div class="portfolio-container">
                    <div class="portfolio-header">
                        <h3>ğŸ’¼ ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h3>
                        <div class="portfolio-actions">
                            <button onclick="showAddStockModal()" class="add-stock-btn">
                                â• ä¿æœ‰æ ªè¿½åŠ 
                            </button>
                            <button onclick="refreshPortfolio()" class="refresh-btn">
                                ğŸ”„ æ›´æ–°
                            </button>
                        </div>
                    </div>
                    
                    <!-- ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã‚µãƒãƒªãƒ¼ -->
                    <div class="portfolio-summary" id="portfolio-summary">
                        <div class="loading">ğŸ“Š ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã‚µãƒãƒªãƒ¼ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
                    </div>
                    
                    <!-- ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ -->
                    <div class="portfolio-tabs">
                        <button class="portfolio-tab-btn active" onclick="showPortfolioTab('holdings')">
                            ğŸ“ˆ ä¿æœ‰éŠ˜æŸ„
                        </button>
                        <button class="portfolio-tab-btn" onclick="showPortfolioTab('watchlist')">
                            ğŸ‘ï¸ ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆ
                        </button>
                        <button class="portfolio-tab-btn" onclick="showPortfolioTab('alerts')">
                            ğŸ”” ã‚¢ãƒ©ãƒ¼ãƒˆ
                        </button>
                        <button class="portfolio-tab-btn" onclick="showPortfolioTab('notes')">
                            ğŸ“ æŠ•è³‡ãƒãƒ¼ãƒˆ
                        </button>
                    </div>
                    
                    <!-- ä¿æœ‰éŠ˜æŸ„ã‚¿ãƒ– -->
                    <div id="holdings-tab" class="portfolio-tab-content active">
                        <div id="holdings-list" class="holdings-container">
                            <div class="loading">ğŸ“ˆ ä¿æœ‰éŠ˜æŸ„ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
                        </div>
                    </div>
                    
                    <!-- ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆã‚¿ãƒ– -->
                    <div id="watchlist-tab" class="portfolio-tab-content">
                        <div class="watchlist-header">
                            <button onclick="showAddWatchModal()" class="add-watch-btn">
                                â• éŠ˜æŸ„è¿½åŠ 
                            </button>
                        </div>
                        <div id="watchlist-content">
                            <div class="loading">ğŸ‘ï¸ ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
                        </div>
                    </div>
                    
                    <!-- ã‚¢ãƒ©ãƒ¼ãƒˆã‚¿ãƒ– -->
                    <div id="alerts-tab" class="portfolio-tab-content">
                        <div id="alerts-content">
                            <div class="loading">ğŸ”” ã‚¢ãƒ©ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
                        </div>
                    </div>
                    
                    <!-- æŠ•è³‡ãƒãƒ¼ãƒˆã‚¿ãƒ– -->
                    <div id="notes-tab" class="portfolio-tab-content">
                        <div class="notes-header">
                            <button onclick="showAddNoteModal()" class="add-note-btn">
                                â• ãƒãƒ¼ãƒˆè¿½åŠ 
                            </button>
                        </div>
                        <div id="notes-content">
                            <div class="loading">ğŸ“ æŠ•è³‡ãƒãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
                        </div>
                    </div>
                    
                    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ç”¨ã‚³ãƒ³ãƒ†ãƒŠ -->
                    <div id="portfolio-modals"></div>
                </div>
                
                <style>
                .portfolio-container {
                    background: #1f2937;
                    border-radius: 10px;
                    padding: 20px;
                    margin: 20px 0;
                }
                
                .portfolio-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 20px;
                }
                
                .portfolio-header h3 {
                    color: #3b82f6;
                    margin: 0;
                }
                
                .portfolio-actions {
                    display: flex;
                    gap: 10px;
                }
                
                .add-stock-btn, .refresh-btn, .add-watch-btn, .add-note-btn {
                    background: #3b82f6;
                    color: white;
                    border: none;
                    padding: 8px 16px;
                    border-radius: 5px;
                    cursor: pointer;
                    font-size: 14px;
                    transition: background 0.3s;
                }
                
                .add-stock-btn:hover, .refresh-btn:hover, .add-watch-btn:hover, .add-note-btn:hover {
                    background: #2563eb;
                }
                
                .portfolio-summary {
                    background: #374151;
                    border-radius: 8px;
                    padding: 20px;
                    margin-bottom: 20px;
                }
                
                .portfolio-tabs {
                    display: flex;
                    border-bottom: 1px solid #4b5563;
                    margin-bottom: 20px;
                }
                
                .portfolio-tab-btn {
                    background: none;
                    border: none;
                    color: #9ca3af;
                    padding: 12px 20px;
                    cursor: pointer;
                    transition: color 0.3s, border-bottom 0.3s;
                    border-bottom: 2px solid transparent;
                }
                
                .portfolio-tab-btn.active {
                    color: #3b82f6;
                    border-bottom-color: #3b82f6;
                }
                
                .portfolio-tab-btn:hover {
                    color: #e5e7eb;
                }
                
                .portfolio-tab-content {
                    display: none;
                }
                
                .portfolio-tab-content.active {
                    display: block;
                }
                
                .holdings-container {
                    background: #374151;
                    border-radius: 8px;
                    overflow: hidden;
                }
                
                .watchlist-header, .notes-header {
                    margin-bottom: 15px;
                }
                
                .loading {
                    text-align: center;
                    padding: 20px;
                    color: #9ca3af;
                }
                </style>
            `;
            
            portfolioContent.innerHTML = portfolioHtml;
            
            // ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
            initializePortfolio();
        }
        
        // ã‚¹ã‚¤ãƒ³ã‚°åˆ†æã‚³ãƒ³ãƒ†ãƒ³ãƒ„èª­ã¿è¾¼ã¿
        function loadSwingContent() {
            const swingContent = document.getElementById('swing-content');
            if (!swingContent) return;
            
            const currentResults = window.currentAnalysisResults;
            if (!currentResults || !currentResults.successful.length) {
                swingContent.innerHTML = '<div class="error">âŒ åˆ†æçµæœãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«æ ªä¾¡åˆ†æã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</div>';
                return;
            }
            
            // 6ãƒ¶æœˆé–“ã®ã‚¹ã‚¤ãƒ³ã‚°åˆ†æãƒãƒ£ãƒ¼ãƒˆç”Ÿæˆ
            swingContent.innerHTML = '<div class="loading">ğŸ“ˆ ã‚¹ã‚¤ãƒ³ã‚°åˆ†æãƒãƒ£ãƒ¼ãƒˆã‚’ç”Ÿæˆä¸­...</div>';
            generateSwingChart();
        }
        
        // ã‚¹ã‚¤ãƒ³ã‚°åˆ†æãƒãƒ£ãƒ¼ãƒˆç”Ÿæˆæ©Ÿèƒ½
        async function generateSwingChart() {
            const currentResults = window.currentAnalysisResults;
            if (!currentResults || !currentResults.successful.length) return;
            
            const firstTicker = currentResults.successful[0].ticker;
            
            try {
                const response = await fetch('/swing_analysis', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ticker: firstTicker })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    renderSwingChart(result.data, firstTicker);
                } else {
                    document.getElementById('swing-content').innerHTML = 
                        `<div class="error">âŒ ã‚¨ãƒ©ãƒ¼: ${result.error}</div>`;
                }
            } catch (error) {
                console.error('Swing chart generation error:', error);
                document.getElementById('swing-content').innerHTML = 
                    `<div class="error">âŒ ãƒãƒ£ãƒ¼ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
            }
        }
        
        // ã‚¹ã‚¤ãƒ³ã‚°åˆ†æãƒãƒ£ãƒ¼ãƒˆè¡¨ç¤ºæ©Ÿèƒ½
        function renderSwingChart(data, ticker) {
            const swingContent = document.getElementById('swing-content');
            
            // ãƒãƒ£ãƒ¼ãƒˆã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆ
            const chartHtml = `
                <div class="swing-analysis-container">
                    <h3 style="color: #2563eb; margin-bottom: 20px;">
                        ğŸ“ˆ ${ticker} - 6ãƒ¶æœˆã‚¹ã‚¤ãƒ³ã‚°åˆ†æãƒãƒ£ãƒ¼ãƒˆ
                    </h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr; gap: 15px;">
                        <!-- ãƒ¡ã‚¤ãƒ³ãƒãƒ£ãƒ¼ãƒˆ: ä¾¡æ ¼ + ç§»å‹•å¹³å‡ + ãƒœãƒªãƒ³ã‚¸ãƒ£ãƒ¼ãƒãƒ³ãƒ‰ + å‡ºæ¥é«˜ -->
                        <div id="swing-main-chart" style="height: 600px;"></div>
                        
                        <!-- ã‚µãƒ–ãƒãƒ£ãƒ¼ãƒˆ: RSI -->
                        <div id="swing-rsi-chart" style="height: 150px;"></div>
                        
                        <!-- ã‚µãƒ–ãƒãƒ£ãƒ¼ãƒˆ: MACD -->
                        <div id="swing-macd-chart" style="height: 150px;"></div>
                        
                        <!-- ã‚µãƒ–ãƒãƒ£ãƒ¼ãƒˆ: ATR -->
                        <div id="swing-atr-chart" style="height: 150px;"></div>
                    </div>
                    
                    <!-- ã‚·ã‚°ãƒŠãƒ«ã‚µãƒãƒªãƒ¼ -->
                    <div class="signals-summary" style="margin-top: 20px;">
                        <h4>ğŸ¯ æ¤œå‡ºã•ã‚ŒãŸã‚·ã‚°ãƒŠãƒ«</h4>
                        <div id="swing-signals-list"></div>
                    </div>
                </div>
            `;
            
            swingContent.innerHTML = chartHtml;
            
            // Plotlyã§ãƒãƒ£ãƒ¼ãƒˆã‚’æç”»
            createSwingMainChart(data, ticker);
            createSwingRSIChart(data, ticker);
            createSwingMACDChart(data, ticker);
            createSwingATRChart(data, ticker);
            updateSwingSignalsDisplay(data.signals);
        }
        
        // ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ©Ÿèƒ½
        async function runBacktest() {
            const ticker = document.getElementById('backtest-ticker')?.value;
            const period = document.getElementById('backtest-period')?.value || '6mo';
            const strategy = document.getElementById('backtest-strategy')?.value || 'combo';
            const capital = parseInt(document.getElementById('backtest-capital')?.value || '1000000');
            
            if (!ticker) {
                alert('å¯¾è±¡éŠ˜æŸ„ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            const resultsDiv = document.getElementById('backtest-results');
            resultsDiv.innerHTML = '<div class="loading">âš¡ ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...</div>';
            
            try {
                console.log('ğŸš€ Starting backtest for:', { ticker, period, strategy, capital });
                
                const response = await fetch('/backtest', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ticker: ticker.replace('.T', ''),
                        start_date: getDateXMonthsAgo(getPeriodMonths(period)),
                        end_date: new Date().toISOString().split('T')[0],
                        strategy: strategy,
                        initial_capital: capital
                    })
                });
                
                const result = await response.json();
                console.log('âš¡ Backtest result:', result);
                
                if (result.success) {
                    displayBacktestResults(result.data);
                } else {
                    resultsDiv.innerHTML = `<div class="error">âŒ ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${result.error}</div>`;
                }
                
            } catch (error) {
                console.error('âŒ Backtest error:', error);
                resultsDiv.innerHTML = `<div class="error">âŒ ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
            }
        }
        
        // ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆçµæœè¡¨ç¤ºï¼ˆæ”¹å–„ç‰ˆï¼‰
        function displayBacktestResults(data) {
            const backtest = data.backtest_result;
            const metrics = data.detailed_metrics;
            
            // å®‰å…¨ãªæ•°å€¤å–å¾—
            const safeNum = (val, defaultVal = 0) => (val !== undefined && val !== null && !isNaN(val) && isFinite(val)) ? val : defaultVal;
            const safeFormat = (val, decimals = 2) => safeNum(val).toFixed(decimals);
            const safeCurrency = (val) => new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' }).format(safeNum(val));
            
            // æœŸé–“è¨ˆç®—ã®ä¿®æ­£
            const startDate = data.chart_data?.dates?.[0] || 'N/A';
            const endDate = data.chart_data?.dates?.[data.chart_data?.dates?.length - 1] || 'N/A';
            
            const html = `
                <div class="stock-card">
                    <div class="stock-header">
                        âš¡ ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆçµæœ - ${data.strategy_info?.name || 'æˆ¦ç•¥'}
                    </div>
                    
                    <div class="signals-grid">
                        <div class="signal-item">
                            <span class="signal-label">ç·ãƒªã‚¿ãƒ¼ãƒ³</span>
                            <span class="signal-value signal-${safeNum(backtest.performance?.total_return_pct) > 0 ? 'buy' : 'sell'}">
                                ${safeFormat(backtest.performance?.total_return_pct)}%
                            </span>
                        </div>
                        
                        <div class="signal-item">
                            <span class="signal-label">å‹ç‡</span>
                            <span class="signal-value signal-${safeNum(backtest.performance?.win_rate) > 50 ? 'buy' : 'neutral'}">
                                ${safeFormat(backtest.performance?.win_rate, 1)}%
                            </span>
                        </div>
                        
                        <div class="signal-item">
                            <span class="signal-label">å–å¼•å›æ•°</span>
                            <span class="signal-value signal-neutral">
                                ${safeNum(backtest.trades_count)}å›
                            </span>
                        </div>
                        
                        <div class="signal-item">
                            <span class="signal-label">æœ€å¤§ãƒ‰ãƒ­ãƒ¼ãƒ€ã‚¦ãƒ³</span>
                            <span class="signal-value signal-${Math.abs(safeNum(backtest.risk_metrics?.max_drawdown)) < 10 ? 'buy' : 'sell'}">
                                ${safeFormat(backtest.risk_metrics?.max_drawdown)}%
                            </span>
                        </div>
                        
                        <div class="signal-item">
                            <span class="signal-label">ã‚·ãƒ£ãƒ¼ãƒ—ãƒ¬ã‚·ã‚ª</span>
                            <span class="signal-value signal-${safeNum(backtest.risk_metrics?.sharpe_ratio) > 1 ? 'buy' : 'neutral'}">
                                ${safeFormat(backtest.risk_metrics?.sharpe_ratio)}
                            </span>
                        </div>
                        
                        <div class="signal-item">
                            <span class="signal-label">å¸‚å ´æ¯”è¼ƒ</span>
                            <span class="signal-value signal-${safeNum(backtest.market_comparison?.alpha) > 0 ? 'buy' : 'neutral'}">
                                Î±: ${safeFormat(backtest.market_comparison?.alpha)}%
                            </span>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #2d3748; border-radius: 8px;">
                        <h4 style="color: #63b3ed; margin-bottom: 10px;">ğŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è©•ä¾¡</h4>
                        <div style="color: #a0aec0;">
                            <strong>æˆ¦ç•¥:</strong> ${data.strategy_info?.description || 'è¤‡åˆæˆ¦ç•¥'}<br>
                            <strong>æœŸé–“:</strong> ${startDate} ï½ ${endDate}<br>
                            <strong>åˆæœŸè³‡é‡‘:</strong> ${safeCurrency(metrics?.basic_stats?.initial_capital)}<br>
                            <strong>æœ€çµ‚è³‡ç”£:</strong> ${safeCurrency(metrics?.basic_stats?.final_value)}
                        </div>
                    </div>
                    
                    <div class="chart-container" id="backtest-chart" style="margin-top: 20px; height: 400px;">
                        <div class="loading">ğŸ“ˆ ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆãƒãƒ£ãƒ¼ãƒˆä½œæˆä¸­...</div>
                    </div>
                    
                    ${data.trades && data.trades.length > 0 ? `
                        <div style="margin-top: 15px; padding: 15px; background: #2d3748; border-radius: 8px;">
                            <h4 style="color: #63b3ed; margin-bottom: 10px;">ğŸ“‹ å–å¼•å±¥æ­´ (æœ€æ–°5ä»¶)</h4>
                            ${data.trades.slice(0, 5).map(trade => `
                                <div style="margin: 8px 0; padding: 8px; background: #374151; border-radius: 4px; font-size: 14px;">
                                    ${trade.entry_date} ï½ ${trade.exit_date} | 
                                    ${safeNum(trade.entry_price)}å†† â†’ ${safeNum(trade.exit_price)}å†† | 
                                    <span style="color: ${safeNum(trade.profit_loss) > 0 ? '#48bb78' : '#f56565'}">
                                        ${safeNum(trade.profit_loss) > 0 ? '+' : ''}${safeFormat(trade.profit_loss_pct)}%
                                    </span>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
            
            document.getElementById('backtest-results').innerHTML = html;
            
            // ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆãƒãƒ£ãƒ¼ãƒˆä½œæˆ
            if (data.chart_data && data.chart_data.dates && data.chart_data.prices) {
                setTimeout(() => {
                    createBacktestChart(data);
                }, 100);
            }
        }
        
        // ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆãƒãƒ£ãƒ¼ãƒˆä½œæˆ
        function createBacktestChart(data) {
            console.log('ğŸ“ˆ Creating backtest chart');
            
            if (typeof Plotly === 'undefined') {
                document.getElementById('backtest-chart').innerHTML = '<div class="error">âŒ Plotlyãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“</div>';
                return;
            }
            
            const chartData = data.chart_data || {};
            const dates = chartData.dates || [];
            const prices = chartData.prices || [];
            const signals = chartData.signals || {};
            
            if (dates.length === 0 || prices.length === 0) {
                document.getElementById('backtest-chart').innerHTML = '<div class="error">âŒ ãƒãƒ£ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“</div>';
                return;
            }
            
            // ãƒãƒ£ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆ
            const traces = [
                {
                    x: dates,
                    y: prices,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'æ ªä¾¡',
                    line: { color: '#4299e1', width: 2 }
                }
            ];
            
            // è²·ã„ã‚·ã‚°ãƒŠãƒ«è¿½åŠ 
            if (signals.buy_dates && signals.buy_dates.length > 0) {
                traces.push({
                    x: signals.buy_dates,
                    y: signals.buy_prices,
                    type: 'scatter',
                    mode: 'markers',
                    name: 'è²·ã„',
                    marker: { 
                        color: '#48bb78', 
                        size: 8,
                        symbol: 'triangle-up'
                    }
                });
            }
            
            // å£²ã‚Šã‚·ã‚°ãƒŠãƒ«è¿½åŠ   
            if (signals.sell_dates && signals.sell_dates.length > 0) {
                traces.push({
                    x: signals.sell_dates,
                    y: signals.sell_prices,
                    type: 'scatter',
                    mode: 'markers',
                    name: 'å£²ã‚Š',
                    marker: { 
                        color: '#f56565', 
                        size: 8,
                        symbol: 'triangle-down'
                    }
                });
            }
            
            const layout = {
                title: {
                    text: `ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆçµæœ - ${data.strategy_info?.name || 'æˆ¦ç•¥'}`,
                    font: { color: '#ffffff', size: 16 }
                },
                xaxis: {
                    title: 'æ—¥ä»˜',
                    color: '#ffffff',
                    gridcolor: '#4a5568'
                },
                yaxis: {
                    title: 'æ ªä¾¡ (å††)',
                    color: '#ffffff',
                    gridcolor: '#4a5568'
                },
                paper_bgcolor: '#1a202c',
                plot_bgcolor: '#2d3748',
                font: { color: '#ffffff' },
                legend: {
                    font: { color: '#ffffff' }
                },
                margin: { t: 50, r: 50, b: 50, l: 80 }
            };
            
            const config = {
                responsive: true,
                displayModeBar: true,
                modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d'],
                displaylogo: false
            };
            
            Plotly.newPlot('backtest-chart', traces, layout, config);
        }
        
        // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function getPeriodMonths(period) {
            switch(period) {
                case '3mo': return 3;
                case '6mo': return 6;
                case '1y': return 12;
                default: return 6;
            }
        }
        
        function getDateXMonthsAgo(months) {
            const date = new Date();
            date.setMonth(date.getMonth() - months);
            return date.toISOString().split('T')[0];
        }
        
        function createChart(ticker, technical) {
            console.log(`ğŸ¨ Creating chart for ${ticker}`);
            
            if (typeof Plotly === 'undefined') {
                document.getElementById(`chart-${ticker}`).innerHTML = '<div class="error">âŒ Plotlyãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“</div>';
                return;
            }
            
            const chartData = technical.chart_data || {};
            const dates = chartData.dates || [];
            const prices = chartData.prices || [];
            const sma5 = chartData.sma_5 || [];
            const sma25 = chartData.sma_25 || [];
            const volumes = chartData.volume || [];
            
            if (dates.length === 0 || prices.length === 0) {
                document.getElementById(`chart-${ticker}`).innerHTML = '<div class="error">âŒ ãƒãƒ£ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“</div>';
                return;
            }
            
            // ãƒãƒ£ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆ
            const traces = [
                {
                    x: dates,
                    y: prices,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'æ ªä¾¡',
                    line: { color: '#4299e1', width: 2 },
                    yaxis: 'y1'
                },
                {
                    x: dates,
                    y: sma5,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'SMA5',
                    line: { color: '#48bb78', width: 1 },
                    yaxis: 'y1'
                },
                {
                    x: dates,
                    y: sma25,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'SMA25',
                    line: { color: '#ed8936', width: 1 },
                    yaxis: 'y1'
                },
                {
                    x: dates,
                    y: volumes,
                    type: 'bar',
                    name: 'å‡ºæ¥é«˜',
                    marker: { color: 'rgba(66, 153, 225, 0.3)' },
                    yaxis: 'y2'
                }
            ];
            
            const layout = {
                title: {
                    text: `${ticker} æ ªä¾¡ãƒãƒ£ãƒ¼ãƒˆ`,
                    font: { color: '#ffffff', size: 18 }
                },
                xaxis: {
                    title: 'æ—¥ä»˜',
                    gridcolor: '#4a5568',
                    tickfont: { color: '#a0aec0' },
                    titlefont: { color: '#a0aec0' }
                },
                yaxis: {
                    title: 'æ ªä¾¡ (å††)',
                    side: 'left',
                    gridcolor: '#4a5568',
                    tickfont: { color: '#a0aec0' },
                    titlefont: { color: '#a0aec0' }
                },
                yaxis2: {
                    title: 'å‡ºæ¥é«˜',
                    side: 'right',
                    overlaying: 'y',
                    gridcolor: '#4a5568',
                    tickfont: { color: '#a0aec0' },
                    titlefont: { color: '#a0aec0' }
                },
                plot_bgcolor: '#374151',
                paper_bgcolor: '#374151',
                font: { color: '#ffffff' },
                legend: {
                    font: { color: '#a0aec0' },
                    bgcolor: 'rgba(55, 65, 81, 0.8)'
                },
                margin: { l: 60, r: 60, t: 50, b: 50 },
                height: 350
            };
            
            const config = {
                displayModeBar: true,
                responsive: true,
                displaylogo: false,
                modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d', 'autoScale2d']
            };
            
            // ãƒãƒ£ãƒ¼ãƒˆæç”»
            Plotly.newPlot(`chart-${ticker}`, traces, layout, config)
                .then(() => {
                    console.log(`âœ… Chart successfully created for ${ticker}`);
                })
                .catch((error) => {
                    console.error(`âŒ Chart creation error for ${ticker}:`, error);
                    document.getElementById(`chart-${ticker}`).innerHTML = '<div class="error">âŒ ãƒãƒ£ãƒ¼ãƒˆä½œæˆã‚¨ãƒ©ãƒ¼</div>';
                });
        }
        
        function getSignalText(signal) {
            switch(signal) {
                case 'buy': return 'è²·ã„';
                case 'sell': return 'å£²ã‚Š';
                case 'neutral': return 'ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«';
                default: return 'N/A';
            }
        }
        
        function getScoreColor(score) {
            if (score >= 70) return 'buy';
            if (score >= 40) return 'neutral';
            return 'sell';
        }
        
        function getRecommendationText(rec) {
            switch(rec) {
                case 'buy': return 'è²·ã„æ¨å¥¨';
                case 'sell': return 'å£²ã‚Šæ¨å¥¨';
                case 'hold': return 'ä¿ç•™';
                default: return 'N/A';
            }
        }
        
        // Enterã‚­ãƒ¼ã§åˆ†æå®Ÿè¡Œï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«å½¢å¼ã§ã¯ä¸è¦ï¼‰
        // document.getElementById('ticker').addEventListener('keypress', function(e) {
        //     if (e.key === 'Enter') {
        //         analyzeStock();
        //     }
        // });
        
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆéŠ˜æŸ„ãƒ‡ãƒ¼ã‚¿
        const defaultStocks = [
            {ticker: '8001', company: 'ä¼Šè—¤å¿ å•†äº‹', industry: 'ç·åˆå•†ç¤¾'},
            {ticker: '7203', company: 'ãƒˆãƒ¨ã‚¿è‡ªå‹•è»Š', industry: 'è‡ªå‹•è»Š'},
            {ticker: '6758', company: 'ã‚½ãƒ‹ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—', industry: 'é›»æ©Ÿãƒ»IT'},
            {ticker: '9984', company: 'ã‚½ãƒ•ãƒˆãƒãƒ³ã‚¯ã‚°ãƒ«ãƒ¼ãƒ—', industry: 'é€šä¿¡ãƒ»æŠ•è³‡'},
            {ticker: '8306', company: 'ä¸‰è±UFJãƒ•ã‚£ãƒŠãƒ³ã‚·ãƒ£ãƒ«ãƒ»ã‚°ãƒ«ãƒ¼ãƒ—', industry: 'éŠ€è¡Œ'},
            {ticker: '4519', company: 'ä¸­å¤–è£½è–¬', industry: 'åŒ»è–¬å“'},
            {ticker: '6861', company: 'ã‚­ãƒ¼ã‚¨ãƒ³ã‚¹', industry: 'ç²¾å¯†æ©Ÿå™¨'},
            {ticker: '2914', company: 'JTï¼ˆæ—¥æœ¬ãŸã°ã“ç”£æ¥­ï¼‰', industry: 'é£Ÿå“ãƒ»ãŸã°ã“'},
            {ticker: '4063', company: 'ä¿¡è¶ŠåŒ–å­¦å·¥æ¥­', industry: 'åŒ–å­¦'},
            {ticker: '6981', company: 'æ‘ç”°è£½ä½œæ‰€', industry: 'é›»å­éƒ¨å“'}
        ];
        
        // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰çŠ¶æ…‹
        let isEditMode = false;
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ†ãƒ¼ãƒ–ãƒ«åˆæœŸåŒ–
        function initializeStockTable() {
            console.log('ğŸ”„ Initializing stock table...');
            const savedStocks = loadStocksFromStorage();
            const stocks = savedStocks.length > 0 ? savedStocks : defaultStocks;
            renderStockTable(stocks);
            console.log(`âœ… Loaded ${stocks.length} stocks`);
        }
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
        function renderStockTable(stocks) {
            const tbody = document.getElementById('stock-table-body');
            tbody.innerHTML = '';
            
            stocks.forEach(stock => {
                const row = document.createElement('tr');
                row.setAttribute('data-ticker', stock.ticker);
                
                row.innerHTML = `
                    <td><input type="checkbox" class="stock-checkbox" value="${stock.ticker}" ${stock.ticker === '8001' ? 'checked' : ''}></td>
                    <td>${stock.ticker}</td>
                    <td>${stock.company}</td>
                    <td>${stock.industry}</td>
                    <td class="delete-cell" style="display: ${isEditMode ? 'table-cell' : 'none'};">
                        <button onclick="deleteStock('${stock.ticker}')" style="background: #e53e3e; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer;">ğŸ—‘ï¸</button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹åˆ¶å¾¡é–¢æ•°
        function selectAll() {
            const checkboxes = document.querySelectorAll('.stock-checkbox');
            checkboxes.forEach(cb => cb.checked = true);
        }
        
        function selectNone() {
            const checkboxes = document.querySelectorAll('.stock-checkbox');
            checkboxes.forEach(cb => cb.checked = false);
        }
        

        
        // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
        function toggleEditMode() {
            isEditMode = !isEditMode;
            const deleteHeader = document.getElementById('delete-header');
            const deleteCells = document.querySelectorAll('.delete-cell');
            const editBtn = document.getElementById('edit-mode-btn');
            
            if (isEditMode) {
                deleteHeader.style.display = 'table-cell';
                deleteCells.forEach(cell => cell.style.display = 'table-cell');
                editBtn.textContent = 'âœ… ç·¨é›†å®Œäº†';
                editBtn.style.background = '#48bb78';
            } else {
                deleteHeader.style.display = 'none';
                deleteCells.forEach(cell => cell.style.display = 'none');
                editBtn.textContent = 'âœï¸ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰';
                editBtn.style.background = '#4a5568';
            }
        }
        
        // éŠ˜æŸ„è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤º/éè¡¨ç¤º
        function showAddStockForm() {
            document.getElementById('add-stock-form').style.display = 'block';
            document.getElementById('new-ticker').focus();
        }
        
        function hideAddStockForm() {
            document.getElementById('add-stock-form').style.display = 'none';
            document.getElementById('new-ticker').value = '';
            document.getElementById('new-company').value = '';
            document.getElementById('new-industry').value = '';
        }
        
        // éŠ˜æŸ„è¿½åŠ 
        function addStock() {
            const ticker = document.getElementById('new-ticker').value.trim();
            const company = document.getElementById('new-company').value.trim();
            const industry = document.getElementById('new-industry').value.trim();
            
            if (!ticker || !ticker.match(/^\d{4}$/)) {
                alert('4æ¡ã®éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            if (!company) {
                alert('ä¼æ¥­åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            if (!industry) {
                alert('æ¥­ç•Œã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            const stocks = loadStocksFromStorage();
            
            // é‡è¤‡ãƒã‚§ãƒƒã‚¯
            if (stocks.find(s => s.ticker === ticker)) {
                alert('ã“ã®éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™');
                return;
            }
            
            // æ–°ã—ã„éŠ˜æŸ„ã‚’è¿½åŠ 
            stocks.push({ ticker, company, industry });
            saveStocksToStorage(stocks);
            renderStockTable(stocks);
            hideAddStockForm();
            
            console.log(`âœ… Added new stock: ${ticker} - ${company}`);
        }
        
        // éŠ˜æŸ„å‰Šé™¤
        function deleteStock(ticker) {
            if (!confirm(`éŠ˜æŸ„ ${ticker} ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }
            
            let stocks = loadStocksFromStorage();
            stocks = stocks.filter(s => s.ticker !== ticker);
            saveStocksToStorage(stocks);
            renderStockTable(stocks);
            
            console.log(`ğŸ—‘ï¸ Deleted stock: ${ticker}`);
        }
        
        // ã‚¯ã‚¤ãƒƒã‚¯é¸æŠé–¢æ•°ï¼ˆå‰Šé™¤äºˆå®šï¼‰
        function setTickers(tickers) {
            // äº’æ›æ€§ã®ãŸã‚æ®‹ã™ï¼ˆä½¿ç”¨ã•ã‚Œãªããªã‚‹ï¼‰
        }
        
        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ç®¡ç†
        function saveStocksToStorage(stocks) {
            try {
                localStorage.setItem('stockAnalysisStocks', JSON.stringify(stocks));
                console.log('ğŸ’¾ Stocks saved to localStorage');
            } catch (error) {
                console.error('âŒ Failed to save stocks:', error);
            }
        }
        
        function loadStocksFromStorage() {
            try {
                const saved = localStorage.getItem('stockAnalysisStocks');
                if (saved) {
                    const stocks = JSON.parse(saved);
                    console.log('ğŸ“ Stocks loaded from localStorage');
                    return stocks;
                }
            } catch (error) {
                console.error('âŒ Failed to load stocks:', error);
            }
            return [];
        }
        
        // ã‚¹ã‚¤ãƒ³ã‚°åˆ†æç”¨Plotlyãƒãƒ£ãƒ¼ãƒˆä½œæˆé–¢æ•°ç¾¤
        function createSwingMainChart(data, ticker) {
            const traces = [];
            
            // ãƒ­ãƒ¼ã‚½ã‚¯è¶³ãƒãƒ£ãƒ¼ãƒˆ
            traces.push({
                x: data.dates,
                open: data.ohlcv.open,
                high: data.ohlcv.high,
                low: data.ohlcv.low,
                close: data.ohlcv.close,
                type: 'candlestick',
                name: 'ä¾¡æ ¼',
                yaxis: 'y',
                increasing: { line: { color: '#26a69a' } },
                decreasing: { line: { color: '#ef5350' } }
            });
            
            // ç§»å‹•å¹³å‡ç·š
            if (data.indicators.ma_5) {
                traces.push({
                    x: data.dates,
                    y: data.indicators.ma_5,
                    type: 'scatter',
                    mode: 'lines',
                    name: '5æ—¥MA',
                    line: { color: '#ff6b6b', width: 1 },
                    yaxis: 'y'
                });
            }
            
            if (data.indicators.ma_25) {
                traces.push({
                    x: data.dates,
                    y: data.indicators.ma_25,
                    type: 'scatter',
                    mode: 'lines',
                    name: '25æ—¥MA',
                    line: { color: '#4ecdc4', width: 2 },
                    yaxis: 'y'
                });
            }
            
            if (data.indicators.ma_75) {
                traces.push({
                    x: data.dates,
                    y: data.indicators.ma_75,
                    type: 'scatter',
                    mode: 'lines',
                    name: '75æ—¥MA',
                    line: { color: '#45b7d1', width: 2 },
                    yaxis: 'y'
                });
            }
            
            // ãƒœãƒªãƒ³ã‚¸ãƒ£ãƒ¼ãƒãƒ³ãƒ‰
            if (data.indicators.bb_upper && data.indicators.bb_lower) {
                traces.push({
                    x: data.dates,
                    y: data.indicators.bb_upper,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'BBä¸Šé™',
                    line: { color: 'rgba(255,0,255,0.3)', width: 1, dash: 'dot' },
                    yaxis: 'y'
                });
                
                traces.push({
                    x: data.dates,
                    y: data.indicators.bb_lower,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'BBä¸‹é™',
                    line: { color: 'rgba(255,0,255,0.3)', width: 1, dash: 'dot' },
                    fill: 'tonexty',
                    fillcolor: 'rgba(255,0,255,0.1)',
                    yaxis: 'y'
                });
            }
            
            // å‡ºæ¥é«˜ï¼ˆ1.5å€ä»¥ä¸Šã¯èµ¤è‰²å¼·èª¿ï¼‰
            const volumeColors = data.ohlcv.volume.map((vol, i) => {
                const ratio = data.indicators.volume_ratio?.[i];
                return ratio && ratio >= 1.5 ? 'red' : 'rgba(100,100,100,0.3)';
            });
            
            traces.push({
                x: data.dates,
                y: data.ohlcv.volume,
                type: 'bar',
                name: 'å‡ºæ¥é«˜',
                marker: { color: volumeColors },
                yaxis: 'y2'
            });
            
            // å£²è²·ã‚·ã‚°ãƒŠãƒ«ãƒãƒ¼ã‚«ãƒ¼
            addSwingSignalMarkers(traces, data);
            
            const layout = {
                title: `${ticker} ã‚¹ã‚¤ãƒ³ã‚°åˆ†æãƒãƒ£ãƒ¼ãƒˆ (6ãƒ¶æœˆ)`,
                xaxis: { type: 'date', rangeslider: { visible: false } },
                yaxis: { title: 'ä¾¡æ ¼ (å††)', side: 'left', position: 0 },
                yaxis2: { title: 'å‡ºæ¥é«˜', side: 'right', overlaying: 'y', position: 1 },
                height: 600,
                showlegend: true,
                plot_bgcolor: 'white',
                paper_bgcolor: 'white'
            };
            
            const config = { responsive: true, displayModeBar: true };
            Plotly.newPlot('swing-main-chart', traces, layout, config);
        }
        
        function createSwingRSIChart(data, ticker) {
            const traces = [{
                x: data.dates,
                y: data.indicators.rsi,
                type: 'scatter',
                mode: 'lines',
                name: 'RSI',
                line: { color: '#9c88ff', width: 2 }
            }];
            
            // RSI 30/70 ãƒ©ã‚¤ãƒ³
            traces.push({
                x: data.dates,
                y: Array(data.dates.length).fill(70),
                type: 'scatter',
                mode: 'lines',
                name: 'å£²ã‚Šé–¾å€¤(70)',
                line: { color: 'red', width: 1, dash: 'dash' }
            });
            
            traces.push({
                x: data.dates,
                y: Array(data.dates.length).fill(30),
                type: 'scatter',
                mode: 'lines',
                name: 'è²·ã„é–¾å€¤(30)',
                line: { color: 'green', width: 1, dash: 'dash' }
            });
            
            const layout = {
                title: 'RSI (14æ—¥)',
                xaxis: { type: 'date' },
                yaxis: { title: 'RSI', range: [0, 100] },
                height: 150,
                showlegend: false,
                plot_bgcolor: 'white',
                paper_bgcolor: 'white'
            };
            
            Plotly.newPlot('swing-rsi-chart', traces, layout, { responsive: true });
        }
        
        function createSwingMACDChart(data, ticker) {
            const traces = [{
                x: data.dates,
                y: data.indicators.macd,
                type: 'scatter',
                mode: 'lines',
                name: 'MACD',
                line: { color: '#4ecdc4', width: 2 }
            }];
            
            if (data.indicators.macd_signal) {
                traces.push({
                    x: data.dates,
                    y: data.indicators.macd_signal,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Signal',
                    line: { color: '#ff6b6b', width: 2 }
                });
            }
            
            if (data.indicators.macd_histogram) {
                const histogramColors = data.indicators.macd_histogram.map(val => 
                    val >= 0 ? 'green' : 'red'
                );
                
                traces.push({
                    x: data.dates,
                    y: data.indicators.macd_histogram,
                    type: 'bar',
                    name: 'Histogram',
                    marker: { color: histogramColors, opacity: 0.6 }
                });
            }
            
            const layout = {
                title: 'MACD (12,26,9)',
                xaxis: { type: 'date' },
                yaxis: { title: 'MACD' },
                height: 150,
                showlegend: false,
                plot_bgcolor: 'white',
                paper_bgcolor: 'white'
            };
            
            Plotly.newPlot('swing-macd-chart', traces, layout, { responsive: true });
        }
        
        function createSwingATRChart(data, ticker) {
            const traces = [{
                x: data.dates,
                y: data.atr,
                type: 'scatter',
                mode: 'lines',
                name: 'ATR',
                line: { color: '#ffa726', width: 2 },
                fill: 'tozeroy',
                fillcolor: 'rgba(255,167,38,0.2)'
            }];
            
            const layout = {
                title: 'ATR (14æ—¥) - ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£æŒ‡æ¨™',
                xaxis: { type: 'date' },
                yaxis: { title: 'ATR' },
                height: 150,
                showlegend: false,
                plot_bgcolor: 'white',
                paper_bgcolor: 'white'
            };
            
            Plotly.newPlot('swing-atr-chart', traces, layout, { responsive: true });
        }
        
        function addSwingSignalMarkers(traces, data) {
            const allSignals = [
                ...data.signals.buy_signals.map(s => ({ ...s, type: 'buy' })),
                ...data.signals.sell_signals.map(s => ({ ...s, type: 'sell' })),
                ...data.signals.golden_cross.map(s => ({ ...s, type: 'golden' })),
                ...data.signals.dead_cross.map(s => ({ ...s, type: 'dead' })),
                ...data.signals.bb_squeeze_break.map(s => ({ ...s, type: 'squeeze' }))
            ];
            
            if (allSignals.length > 0) {
                traces.push({
                    x: allSignals.map(s => s.date),
                    y: allSignals.map(s => s.price),
                    mode: 'markers',
                    type: 'scatter',
                    name: 'å£²è²·ã‚·ã‚°ãƒŠãƒ«',
                    marker: {
                        size: 12,
                        symbol: allSignals.map(s => s.marker || 'circle'),
                        color: allSignals.map(s => s.color || 'blue'),
                        line: { width: 2, color: 'white' }
                    },
                    text: allSignals.map(s => `${s.type}: ${s.reason}`),
                    hovertemplate: '%{text}<br>ä¾¡æ ¼: %{y}å††<extra></extra>',
                    yaxis: 'y'
                });
            }
        }
        
        function updateSwingSignalsDisplay(signals) {
            const signalsContainer = document.getElementById('swing-signals-list');
            let signalsHtml = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 10px;">';
            
            const signalTypes = [
                { key: 'buy_signals', title: 'ğŸŸ¢ è²·ã„ã‚·ã‚°ãƒŠãƒ«', color: 'green' },
                { key: 'sell_signals', title: 'ğŸ”´ å£²ã‚Šã‚·ã‚°ãƒŠãƒ«', color: 'red' },
                { key: 'golden_cross', title: 'ğŸŒŸ ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ã‚¯ãƒ­ã‚¹', color: 'gold' },
                { key: 'dead_cross', title: 'ğŸ’€ ãƒ‡ãƒƒãƒ‰ã‚¯ãƒ­ã‚¹', color: 'orange' },
                { key: 'bb_squeeze_break', title: 'ğŸ’ BBã‚¹ã‚¯ã‚¤ãƒ¼ã‚ºãƒ–ãƒ¬ã‚¤ã‚¯', color: 'purple' }
            ];
            
            signalTypes.forEach(({ key, title, color }) => {
                if (signals[key] && signals[key].length > 0) {
                    signalsHtml += `
                        <div style="padding: 10px; background: rgba(255,255,255,0.1); border-radius: 5px; border-left: 4px solid ${color};">
                            <h5 style="margin: 0 0 5px 0; color: ${color};">${title}</h5>
                            ${signals[key].map(signal => `
                                <div style="font-size: 0.9em; margin: 2px 0;">
                                    ${signal.date}: ${signal.reason} (Â¥${signal.price})
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            });
            
            signalsHtml += '</div>';
            signalsContainer.innerHTML = signalsHtml;
        }
        
        // ===============================================
        // ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  JavaScript é–¢æ•°ç¾¤
        // ===============================================
        
        // ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªåˆæœŸåŒ–
        async function initializePortfolio() {
            console.log('ğŸ“Š Initializing portfolio system...');
            
            try {
                // ä¸¦åˆ—ã§å„ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
                await Promise.all([
                    loadPortfolioSummary(),
                    loadHoldings(),
                    loadWatchlist(),
                    loadAlerts(),
                    loadNotes()
                ]);
                
                console.log('âœ… Portfolio system initialized successfully');
            } catch (error) {
                console.error('âŒ Portfolio initialization failed:', error);
            }
        }
        
        // ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function showPortfolioTab(tabName) {
            // å…¨ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã® active ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
            document.querySelectorAll('.portfolio-tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // å…¨ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éè¡¨ç¤º
            document.querySelectorAll('.portfolio-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // é¸æŠã•ã‚ŒãŸã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–
            const activeTabBtn = document.querySelector(`[onclick="showPortfolioTab('${tabName}')"]`);
            const activeTabContent = document.getElementById(`${tabName}-tab`);
            
            if (activeTabBtn) activeTabBtn.classList.add('active');
            if (activeTabContent) activeTabContent.classList.add('active');
            
            // ã‚¿ãƒ–å›ºæœ‰ã®èª­ã¿è¾¼ã¿å‡¦ç†
            switch(tabName) {
                case 'holdings':
                    loadHoldings();
                    break;
                case 'watchlist':
                    loadWatchlist();
                    break;
                case 'alerts':
                    loadAlerts();
                    break;
                case 'notes':
                    loadNotes();
                    break;
            }
        }
        
        // ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã‚µãƒãƒªãƒ¼èª­ã¿è¾¼ã¿
        async function loadPortfolioSummary() {
            const summaryContainer = document.getElementById('portfolio-summary');
            
            try {
                const response = await fetch('/api/portfolio/portfolio');
                const result = await response.json();
                
                if (result.success && result.data) {
                    const portfolioData = result.data.portfolio || result.data;
                    let totalValue = 0;
                    let totalCost = 0;
                    let totalPnL = 0;
                    
                    if (Array.isArray(portfolioData) && portfolioData.length > 0) {
                        portfolioData.forEach(item => {
                            const currentValue = item.current_price * item.shares;
                            const cost = item.average_price * item.shares;
                            totalValue += currentValue;
                            totalCost += cost;
                            totalPnL += (currentValue - cost);
                        });
                    } else {
                        console.log('ğŸ” Portfolio data is empty or not an array:', portfolioData);
                    }
                    
                    const returnPct = totalCost > 0 ? ((totalPnL / totalCost) * 100) : 0;
                    
                    summaryContainer.innerHTML = `
                        <div class="summary-cards">
                            <div class="summary-card">
                                <h4>ğŸ’° ç¾åœ¨ä¾¡å€¤</h4>
                                <div class="value-large">Â¥${totalValue.toLocaleString()}</div>
                            </div>
                            <div class="summary-card">
                                <h4>ğŸ“Š æŠ•è³‡å…ƒæœ¬</h4>
                                <div class="value-medium">Â¥${totalCost.toLocaleString()}</div>
                            </div>
                            <div class="summary-card">
                                <h4>${totalPnL >= 0 ? 'ğŸ“ˆ' : 'ğŸ“‰'} æç›Š</h4>
                                <div class="value-medium ${totalPnL >= 0 ? 'profit' : 'loss'}">
                                    Â¥${totalPnL.toLocaleString()}
                                </div>
                                <div class="value-small ${totalPnL >= 0 ? 'profit' : 'loss'}">
                                    ${returnPct >= 0 ? '+' : ''}${returnPct.toFixed(2)}%
                                </div>
                            </div>
                            <div class="summary-card">
                                <h4>ğŸ“‹ ä¿æœ‰éŠ˜æŸ„æ•°</h4>
                                <div class="value-medium">${portfolio.length}éŠ˜æŸ„</div>
                            </div>
                        </div>
                        
                        <style>
                        .summary-cards {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                            gap: 15px;
                        }
                        
                        .summary-card {
                            background: #4b5563;
                            padding: 15px;
                            border-radius: 8px;
                            text-align: center;
                        }
                        
                        .summary-card h4 {
                            margin: 0 0 10px 0;
                            color: #d1d5db;
                            font-size: 14px;
                        }
                        
                        .value-large {
                            font-size: 28px;
                            font-weight: bold;
                            color: #3b82f6;
                        }
                        
                        .value-medium {
                            font-size: 20px;
                            font-weight: bold;
                            color: #e5e7eb;
                        }
                        
                        .value-small {
                            font-size: 14px;
                            margin-top: 5px;
                        }
                        
                        .profit { color: #10b981; }
                        .loss { color: #ef4444; }
                        </style>
                    `;
                } else {
                    summaryContainer.innerHTML = `
                        <div class="empty-state">
                            <h4>ğŸ“ˆ ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã¯ç©ºã§ã™</h4>
                            <p>ã€Œä¿æœ‰æ ªè¿½åŠ ã€ãƒœã‚¿ãƒ³ã‹ã‚‰éŠ˜æŸ„ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Summary load error:', error);
                summaryContainer.innerHTML = '<div class="error">ã‚µãƒãƒªãƒ¼èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</div>';
            }
        }
        
        // ä¿æœ‰éŠ˜æŸ„èª­ã¿è¾¼ã¿
        async function loadHoldings() {
            const holdingsContainer = document.getElementById('holdings-list');
            
            try {
                const response = await fetch('/api/portfolio/portfolio');
                const result = await response.json();
                
                if (result.success && result.data) {
                    const portfolioData = result.data.portfolio || result.data;
                    if (Array.isArray(portfolioData) && portfolioData.length > 0) {
                    const holdingsTable = `
                        <table class="holdings-table">
                            <thead>
                                <tr>
                                    <th>éŠ˜æŸ„</th>
                                    <th>ä¿æœ‰æ•°</th>
                                    <th>å¹³å‡å˜ä¾¡</th>
                                    <th>ç¾åœ¨ä¾¡æ ¼</th>
                                    <th>è©•ä¾¡é¡</th>
                                    <th>æç›Š</th>
                                    <th>æç›Šç‡</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${portfolioData.map(item => {
                                    const currentValue = item.current_price * item.shares;
                                    const cost = item.average_price * item.shares;
                                    const pnl = currentValue - cost;
                                    const pnlPct = cost > 0 ? (pnl / cost) * 100 : 0;
                                    
                                    return `
                                        <tr>
                                            <td>
                                                <div class="stock-info">
                                                    <strong>${item.ticker}</strong>
                                                    <div class="company-name">${item.company_name || ''}</div>
                                                </div>
                                            </td>
                                            <td>${item.shares.toLocaleString()}</td>
                                            <td>Â¥${item.average_price.toLocaleString()}</td>
                                            <td>Â¥${item.current_price.toLocaleString()}</td>
                                            <td>Â¥${currentValue.toLocaleString()}</td>
                                            <td class="${pnl >= 0 ? 'profit' : 'loss'}">
                                                Â¥${pnl.toLocaleString()}
                                            </td>
                                            <td class="${pnl >= 0 ? 'profit' : 'loss'}">
                                                ${pnl >= 0 ? '+' : ''}${pnlPct.toFixed(2)}%
                                            </td>
                                            <td>
                                                <button onclick="editHolding(${item.id})" class="edit-btn">âœï¸</button>
                                                <button onclick="deleteHolding(${item.id})" class="delete-btn">ğŸ—‘ï¸</button>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                        
                        <style>
                        .holdings-table {
                            width: 100%;
                            border-collapse: collapse;
                            color: #e5e7eb;
                        }
                        
                        .holdings-table th {
                            background: #4b5563;
                            padding: 12px 8px;
                            text-align: left;
                            font-weight: 600;
                            border-bottom: 2px solid #6b7280;
                        }
                        
                        .holdings-table td {
                            padding: 10px 8px;
                            border-bottom: 1px solid #4b5563;
                        }
                        
                        .holdings-table tr:hover {
                            background: #4b5563;
                        }
                        
                        .stock-info .company-name {
                            font-size: 12px;
                            color: #9ca3af;
                        }
                        
                        .edit-btn, .delete-btn {
                            background: none;
                            border: none;
                            cursor: pointer;
                            font-size: 16px;
                            margin: 0 2px;
                            padding: 4px;
                        }
                        
                        .edit-btn:hover { opacity: 0.7; }
                        .delete-btn:hover { opacity: 0.7; }
                        </style>
                    `;
                    
                    holdingsContainer.innerHTML = holdingsTable;
                    } else {
                        holdingsContainer.innerHTML = `
                            <div class="empty-state">
                                <h4>ğŸ“ˆ ä¿æœ‰éŠ˜æŸ„ãŒã‚ã‚Šã¾ã›ã‚“</h4>
                                <p>ã€Œä¿æœ‰æ ªè¿½åŠ ã€ãƒœã‚¿ãƒ³ã‹ã‚‰éŠ˜æŸ„ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„</p>
                            </div>
                        `;
                    }
                } else {
                    holdingsContainer.innerHTML = `
                        <div class="empty-state">
                            <h4>ğŸ“ˆ ä¿æœ‰éŠ˜æŸ„ãŒã‚ã‚Šã¾ã›ã‚“</h4>
                            <p>ã€Œä¿æœ‰æ ªè¿½åŠ ã€ãƒœã‚¿ãƒ³ã‹ã‚‰éŠ˜æŸ„ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Holdings load error:', error);
                holdingsContainer.innerHTML = '<div class="error">ä¿æœ‰éŠ˜æŸ„èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</div>';
            }
        }
        
        // ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿
        async function loadWatchlist() {
            const watchlistContainer = document.getElementById('watchlist-content');
            watchlistContainer.innerHTML = '<div class="loading">ğŸ‘ï¸ ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';
            
            try {
                const response = await fetch('/api/portfolio/watchlist');
                const result = await response.json();
                
                if (result.success && result.data) {
                    const watchlistData = Array.isArray(result.data) ? result.data : [];
                    if (watchlistData.length > 0) {
                        const watchlistHtml = watchlistData.map(item => `
                        <div class="watchlist-item">
                            <div class="watchlist-info">
                                <div class="ticker-name">
                                    <strong>${item.ticker}</strong>
                                    <span class="company-name">${item.company_name || ''}</span>
                                </div>
                                <div class="target-price">
                                    ç›®æ¨™ä¾¡æ ¼: Â¥${item.target_price?.toLocaleString() || 'N/A'}
                                </div>
                                <div class="category">
                                    ã‚«ãƒ†ã‚´ãƒª: ${item.category || 'æœªåˆ†é¡'}
                                </div>
                            </div>
                            <div class="watchlist-actions">
                                <button onclick="addToPortfolio('${item.ticker}')" class="add-portfolio-btn">ğŸ“ˆ è¿½åŠ </button>
                                <button onclick="removeFromWatchlist(${item.id})" class="remove-btn">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                    `).join('');
                    
                    watchlistContainer.innerHTML = `
                        <div class="watchlist-container">${watchlistHtml}</div>
                        
                        <style>
                        .watchlist-item {
                            background: #4b5563;
                            border-radius: 8px;
                            padding: 15px;
                            margin-bottom: 10px;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        }
                        
                        .watchlist-info .ticker-name {
                            margin-bottom: 5px;
                        }
                        
                        .watchlist-info .company-name {
                            margin-left: 10px;
                            color: #9ca3af;
                            font-size: 14px;
                        }
                        
                        .target-price, .category {
                            font-size: 13px;
                            color: #d1d5db;
                            margin-bottom: 3px;
                        }
                        
                        .watchlist-actions {
                            display: flex;
                            gap: 8px;
                        }
                        
                        .add-portfolio-btn, .remove-btn {
                            background: #3b82f6;
                            color: white;
                            border: none;
                            padding: 6px 12px;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 12px;
                        }
                        
                        .remove-btn {
                            background: #ef4444;
                        }
                        </style>
                    `;
                    } else {
                        watchlistContainer.innerHTML = `
                            <div class="empty-state">
                                <h4>ğŸ‘ï¸ ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆã¯ç©ºã§ã™</h4>
                                <p>ã€ŒéŠ˜æŸ„è¿½åŠ ã€ãƒœã‚¿ãƒ³ã‹ã‚‰æ³¨ç›®éŠ˜æŸ„ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„</p>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('Watchlist load error:', error);
                watchlistContainer.innerHTML = '<div class="error">ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</div>';
            }
        }
        
        // ã‚¢ãƒ©ãƒ¼ãƒˆãƒ»ãƒãƒ¼ãƒˆèª­ã¿è¾¼ã¿ï¼ˆãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ï¼‰
        async function loadAlerts() {
            document.getElementById('alerts-content').innerHTML = `
                <div class="feature-placeholder">
                    <h4>ğŸ”” ä¾¡æ ¼ã‚¢ãƒ©ãƒ¼ãƒˆæ©Ÿèƒ½</h4>
                    <p>ç›®æ¨™ä¾¡æ ¼ãƒ»æåˆ‡ã‚Šãƒ©ã‚¤ãƒ³è¨­å®šæ©Ÿèƒ½ã¯ä»Šå¾Œå®Ÿè£…äºˆå®šã§ã™</p>
                </div>
            `;
        }
        
        async function loadNotes() {
            document.getElementById('notes-content').innerHTML = `
                <div class="feature-placeholder">
                    <h4>ğŸ“ æŠ•è³‡ãƒãƒ¼ãƒˆæ©Ÿèƒ½</h4>
                    <p>æŠ•è³‡åˆ¤æ–­ãƒ»åˆ†æãƒ¡ãƒ¢æ©Ÿèƒ½ã¯ä»Šå¾Œå®Ÿè£…äºˆå®šã§ã™</p>
                </div>
            `;
        }
        
        // ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªæ›´æ–°
        async function refreshPortfolio() {
            console.log('ğŸ”„ Refreshing portfolio...');
            await initializePortfolio();
        }
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢æ•°ï¼ˆãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ï¼‰
        function showAddStockModal() {
            alert('ä¿æœ‰æ ªè¿½åŠ æ©Ÿèƒ½ã¯æ¬¡ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã§å®Ÿè£…äºˆå®šã§ã™');
        }
        
        function showAddWatchModal() {
            alert('ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆè¿½åŠ æ©Ÿèƒ½ã¯æ¬¡ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã§å®Ÿè£…äºˆå®šã§ã™');
        }
        
        function showAddNoteModal() {
            alert('æŠ•è³‡ãƒãƒ¼ãƒˆè¿½åŠ æ©Ÿèƒ½ã¯æ¬¡ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã§å®Ÿè£…äºˆå®šã§ã™');
        }
        
        // æ“ä½œé–¢æ•°ï¼ˆãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ï¼‰
        function editHolding(id) {
            alert(`ä¿æœ‰éŠ˜æŸ„ç·¨é›†æ©Ÿèƒ½ï¼ˆID: ${id}ï¼‰ã¯æ¬¡ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã§å®Ÿè£…äºˆå®šã§ã™`);
        }
        
        function deleteHolding(id) {
            if (confirm('ã“ã®ä¿æœ‰éŠ˜æŸ„ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                alert(`å‰Šé™¤æ©Ÿèƒ½ï¼ˆID: ${id}ï¼‰ã¯æ¬¡ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã§å®Ÿè£…äºˆå®šã§ã™`);
            }
        }
        
        function removeFromWatchlist(id) {
            if (confirm('ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                alert(`å‰Šé™¤æ©Ÿèƒ½ï¼ˆID: ${id}ï¼‰ã¯æ¬¡ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã§å®Ÿè£…äºˆå®šã§ã™`);
            }
        }
        
        function addToPortfolio(ticker) {
            alert(`${ticker}ã‚’ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã«è¿½åŠ ã™ã‚‹æ©Ÿèƒ½ã¯æ¬¡ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã§å®Ÿè£…äºˆå®šã§ã™`);
        }
        
        // ===============================================
        // ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªç®¡ç†ã‚·ã‚¹ãƒ†ãƒ é–¢æ•°ç¾¤ã“ã“ã¾ã§
        // ===============================================
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†æ™‚ã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸ” DEBUG: v7.0 3-Mode Integration loaded successfully at', new Date().toLocaleString());
            initializeStockTable();
        });
        
        console.log('ğŸš€ 3-Mode Integration Stock Analysis Tool v7.0 loaded');
    </script>
</body>
</html>